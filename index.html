<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Í∞ÑÌé∏ ÌïúÍ∏ÄÌôî Î≤àÏó≠Í∏∞</title>
    <style>
        
        :root, body[data-theme="original-pink"] {
            --bg-main: #f5f7fa;
            --bg-container: rgba(255, 255, 255, 0.95);
            --bg-section: #fafafa;
            --bg-input: #ffffff;
            --bg-success: #e8f5e8;
            --bg-warning: #fff3e0;
            --bg-error: #ffebee;
            --bg-btn-success: #f9f5f7;
            --bg-btn-success-hover: #ece7ec;
            --bg-btn-secondary: rgba(234, 106, 161, 0.95);
            --bg-btn-secondary-hover: #f89fc5;
            --bg-progress-bar: #e0e0e0;
            --bg-progress-fill: #a1ea66;
            --bg-result-stats: #e7f1f6;
            --bg-file-label: #efeded;
            --bg-file-label-hover: #e9ecef;

            --text-title: #2c3e50;
            --text-subtitle: #666;
            --text-section-title: #333;
            --text-label: #555;
            --text-input: #000000;
            --text-btn-primary: #ffffff;
            --text-btn-secondary: #ffffff;
            --text-btn-success: rgb(76, 57, 63);
            --text-status-connected: #2e7d32;
            --text-status-connecting: #f57c00;
            --text-status-disconnected: #c62828;
            --text-file-label: #495057;
            --text-file-label-hover: #4f8ee6;
            
            --border-main: #e0e0e0;
            --border-input: #ddd;
            --border-focus: #ea66b7; 
            --border-section-title-accent: #8566ea;
            --border-success: #c8e6c9;
            --border-warning: #ffcc02;
            --border-error: #ffcdd2;
            --border-btn-success: #ecc5d2d3;
            --border-result-stats: #66bcea;
            --border-file-label: #d6cfd3;
            --border-file-label-hover: #4f8ee6;

            --btn-primary-bg: #ea6aa1;
            --btn-primary-hover: #f89fc5;

            --shadow-container: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        body[data-theme="deep-forest"] {
            --bg-main: #111A19;
            --bg-container: rgba(23, 34, 33, 0.95);
            --bg-section: #284139;
            --bg-input: #1a2c2a;
            --bg-success: rgba(128, 144, 118, 0.2);
            --bg-warning: rgba(248, 215, 148, 0.2);
            --bg-error: rgba(184, 104, 48, 0.2);
            --bg-btn-success: #809076;
            --bg-btn-success-hover: #97a88d;
            --bg-btn-secondary: #B86830;
            --bg-btn-secondary-hover: #c6804e;
            --bg-progress-bar: #809076;
            --bg-progress-fill: #F8D794;
            --bg-result-stats: rgba(40, 65, 57, 1);
            --bg-file-label: #284139;
            --bg-file-label-hover: #3a5a51;

            --text-title: #F8D794;
            --text-subtitle: #b0c9a2;
            --text-section-title: #f0f0f0;
            --text-label: #d8e8ce;
            --text-input: #e0e0e0;
            --text-btn-primary: #995322;
            --text-btn-secondary: #ffffff;
            --text-btn-success: #ffffff;
            --text-status-connected: #a7f0a7;
            --text-status-connecting: #F8D794;
            --text-status-disconnected: #f0a7a7;
            --text-file-label: #F8D794;
            --text-file-label-hover: #ffffff;
            
            --border-main: #809076;
            --border-input: #809076;
            --border-focus: #F8D794;
            --border-section-title-accent: #F8D794;
            --border-success: #809076;
            --border-warning: #F8D794;
            --border-error: #B86830;
            --border-btn-success: #809076;
            --border-result-stats: #F8D794;
            --border-file-label: #809076;
            --border-file-label-hover: #F8D794;

            --btn-primary-bg: #ffd47d;
            --btn-primary-hover: #f7dfa1;

            --shadow-container: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        body[data-theme="citrus-grove"] {
            --bg-main: #fdfaf4;
            --bg-container: rgba(255, 255, 255, 0.95);
            --bg-section: #fff;
            --bg-input: #ffffff;
            --bg-success: rgba(171, 194, 112, 0.15);
            --bg-warning: rgba(254, 200, 104, 0.15);
            --bg-error: rgba(253, 167, 105, 0.15);
            --bg-btn-success: #f0f5e6;
            --bg-btn-success-hover: #e6edd9;
            --bg-btn-secondary: #ABC270;
            --bg-btn-secondary-hover: #c0d18f;
            --bg-progress-bar: #e0e0e0;
            --bg-progress-fill: #ABC270;
            --bg-result-stats: #fff8ed;
            --bg-file-label: #f0f5e6;
            --bg-file-label-hover: #e6edd9;

            --text-title: #473C33;
            --text-subtitle: #7a6e62;
            --text-section-title: #473C33;
            --text-label: #615347;
            --text-input: #000000;
            --text-btn-primary: #ffffff;
            --text-btn-secondary: #ffffff;
            --text-btn-success: #473C33;
            --text-status-connected: #5d7331;
            --text-status-connecting: #b5893a;
            --text-status-disconnected: #b46d3e;
            --text-file-label: #473C33;
            --text-file-label-hover: #FDA769;
            
            --border-main: #e8e3d8;
            --border-input: #dcd7ce;
            --border-focus: #FDA769;
            --border-section-title-accent: #FEC868;
            --border-success: #d8e0c0;
            --border-warning: #fee8b9;
            --border-error: #fcdbc2;
            --border-btn-success: #d8e0c0;
            --border-result-stats: #FEC868;
            --border-file-label: #d8e0c0;
            --border-file-label-hover: #FDA769;

            --btn-primary-bg: #FDA769;
            --btn-primary-hover: #fdb88c;

            --shadow-container: 0 20px 40px rgba(71, 60, 51, 0.1);
        }

        body[data-theme="modern-slate"] {
            --bg-main: #f4f4f6;
            --bg-container: rgba(255, 255, 255, 0.95);
            --bg-section: #ffffff;
            --bg-input: #ffffff;
            --bg-success: rgba(62, 80, 88, 0.1);
            --bg-warning: rgba(85, 83, 88, 0.1);
            --bg-error: rgba(65, 79, 107, 0.15);
            --bg-btn-success: #f7f6f5;
            --bg-btn-success-hover: #EFEBE4;
            --bg-btn-secondary: #555358;
            --bg-btn-secondary-hover: #6c6a6f;
            --bg-progress-bar: #e0e0e0;
            --bg-progress-fill: #3E5058;
            --bg-result-stats: #f8f9fa;
            --bg-file-label: #f7f6f5;
            --bg-file-label-hover: #EFEBE4;

            --text-title: #3E5058;
            --text-subtitle: #555358;
            --text-section-title: #3E5058;
            --text-label: #555358;
            --text-input: #000000;
            --text-btn-primary: #ffffff;
            --text-btn-secondary: #ffffff;
            --text-btn-success: #3E5058;
            --text-status-connected: #3E5058;
            --text-status-connecting: #555358;
            --text-status-disconnected: #414F6B;
            --text-file-label: #3E5058;
            --text-file-label-hover: #414F6B;
            
            --border-main: #EFEBE4;
            --border-input: #d9d5cf;
            --border-focus: #414F6B;
            --border-section-title-accent: #414F6B;
            --border-success: #bec8cc;
            --border-warning: #c3c2c4;
            --border-error: #b7bfd1;
            --border-btn-success: #d9d5cf;
            --border-result-stats: #414F6B;
            --border-file-label: #d9d5cf;
            --border-file-label-hover: #414F6B;

            --btn-primary-bg: #414F6B;
            --btn-primary-hover: #56688a;

            --shadow-container: 0 20px 40px rgba(85, 83, 88, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-main);
            min-height: 100vh;
            padding: 15px;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }
                
        .container {
            position: relative; 
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg-container);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow-container);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .title {
            font-size: 1.8em;
            color: var(--text-title);
            margin-bottom: 8px;
            font-weight: 600;
        }        

        .subtitle {
            color: var(--text-subtitle);
            font-size: 1.1em;
        }
        
        .section {
            margin-bottom: 25px;
            padding: 20px;
            border: 2px solid var(--border-main);
            border-radius: 15px;
            background: var(--bg-section);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .section-title-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap; 
            position: relative;
        }
        
        .section-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--text-section-title);
            display: flex;
            align-items: center;
        }
        
        .section-title-container .section-title {
            margin-bottom: 0;
        }

        .section-title-last {
            margin-bottom: 0px !important;
        }
        
        .section-title::before {
            content: "";
            width: 4px;
            height: 20px;
            background: var(--border-section-title-accent);
            margin-right: 10px;
            border-radius: 2px;
            transition: background-color 0.3s ease;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .settings-grid-margin {
            margin-bottom: 15px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .char-counter {
            position: absolute;
            bottom: 5px;
            right: 20px;
            font-size: 12px;
            color: var(--text-subtitle);
            background-color: var(--bg-input);
            padding: 2px 6px;
            border-radius: 5px;
            pointer-events: none; /* ÎßàÏö∞Ïä§ ÌÅ¥Î¶≠Ïù¥ Ïπ¥Ïö¥ÌÑ∞ Îí§Ïùò ÌÖçÏä§Ìä∏Ï∞ΩÏúºÎ°ú Ï†ÑÎã¨ÎêòÎèÑÎ°ù ÏÑ§Ï†ï */
            transition: color 0.3s ease, background-color 0.3s ease;
            opacity: 0.8;
        }
        
        label {
            font-weight: 500;
            margin: 0px 0px 5px 5px;
            color: var(--text-label);
        }

        label-checkbox {
            color: white;
        }
        
        input, select, textarea {
            padding: 12px;
            border: 2px solid var(--border-input);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background-color: var(--bg-input);
            color: var(--text-input);
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--border-focus);
        }
        
        .connection-status {
            padding: 8px 12px;
            border-radius: 10px;
            text-align: center;
            font-weight: 500;
            font-size: 13px;
            margin-top: 12px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .status-disconnected {
            background: var(--bg-error);
            color: var(--text-status-disconnected);
            border: 2px solid var(--border-error);
        }
        
        .status-connected {
            background: var(--bg-success);
            color: var(--text-status-connected);
            border: 2px solid var(--border-success);
        }
        
        .status-connecting {
            background: var(--bg-warning);
            color: var(--text-status-connecting);
            border: 2px solid var(--border-warning);
        }
        
        .textarea-large {
            min-height: 200px;
            resize: vertical;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }
        
        .textarea-medium {
            min-height: 120px;
            resize: vertical;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        .textarea-large::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        .textarea-large::-webkit-scrollbar {
            width: 12px;
        }
        .textarea-large::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .textarea-medium::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        .textarea-medium::-webkit-scrollbar {
            width: 12px;
        }
        .textarea-medium::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
            align-items: center; 
        }
                
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            text-transform: none;
            letter-spacing: 0.3px;
        }

        .btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.15);
        }

        .btn:hover:before {
            left: 100%;
        }

        .btn-primary {
            background: var(--btn-primary-bg);
            color: var(--text-btn-primary);
            border: none;
        }

        .btn-primary:hover {
            background: var(--btn-primary-hover);
        }

        .btn-secondary {
            background: var(--bg-btn-secondary);
            color: var(--text-btn-secondary);
            border: none;
        }

        .btn-secondary:hover {
            background: var(--bg-btn-secondary-hover);
            opacity: 1;
        }

        .btn-success {
            background: var(--bg-btn-success);
            color: var(--text-btn-success);
            border: 2px solid var(--border-btn-success);
        }

        .btn-success:hover {
            background: var(--bg-btn-success-hover);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
            margin-left: 2px;
            border-radius: 8px;
            font-weight: 500;
        }

        .btn-small-test {
            min-width: 90px;
        }

        .btn-text-like {
            background: none;
            border: none;
            color: var(--text-subtitle);
            cursor: pointer;
            padding: 0;
            font-size: 13px;
            font-weight: 500;
            margin: 0px 6px 3px 0px;
        }

        .btn-text-like:hover {
            color: var(--text-title);
            text-decoration: underline;
        }

        .inputText-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .api-key-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .api-key-actions #connectionStatus {
            margin-top: 0;
            margin-bottom: 0;
        }

        #apiKey {
            width: 100%;
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .settings-inline {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .input-with-button {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .input-with-button input {
            flex-grow: 1; 
            min-width: 100px;
        }

        .input-with-button .btn {
            flex-shrink: 0;
        }

        .settings-inline-btn {
            margin-top: 15px;
        }
        
        .action-button-container {
            display: flex;
            justify-content: flex-start;
            margin-top: 15px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--bg-progress-bar);
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--bg-progress-fill);
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s ease, background-color 0.3s ease;
        }
        
        .result-stats {
            background: var(--bg-result-stats);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 4px solid var(--border-result-stats);
            color: var(--text-label);
        }
        
        .warning {
            background: #fff3cd; 
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .save-load-section {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            padding: 8px 15px;
            margin: 0px !important;
            text-align: center;
            background: var(--bg-file-label);
            border: 2px dashed var(--border-file-label);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: var(--text-file-label);
        }

        .file-label:hover {
            background: var(--bg-file-label-hover);
            border-color: var(--border-file-label-hover);
            color: var(--text-file-label-hover);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }
        
        .theme-switcher {
            position: absolute;
            top: 30px;  
            right: 30px; 
            display: flex;
            gap: 8px;
            z-index: 100;
        }

        .theme-button {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 0;
        }

        .theme-button:hover {
            transform: scale(1.15);
            border-color: rgba(0,0,0,0.3);
        }

        .theme-button.active {
            border: 3px solid var(--border-focus);
            transform: scale(1.1);
        }
        
        .feather {
            width: 1em; 
            height: 1em;
            stroke: currentColor; 
            stroke-width: 2; 
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none; 
            vertical-align: -0.1em; 
        }

        .section-title .feather {
            width: 1.1em; 
            height: 1.1em;
            stroke-width: 2; 
            margin-right: 8px; 
            margin-top: 3px;
            vertical-align: -0.2em;
        }
        
        .btn .feather {
            margin-right: 4px; 
            vertical-align: -0.15em;
        }

        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column-reverse; 
            gap: 10px; 
            align-items: flex-end; 
        }

        .toast-notification {
            
            width: max-content; 
            max-width: 350px;   
            padding: 15px 25px;
            border-radius: 12px;
            color: var(--text-btn-primary);
            font-size: 15px;
            font-weight: 500;
            opacity: 0;
            transform: translateX(100%); 
            transition: all 0.4s ease-in-out; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .toast-notification.show {
            opacity: 1;
            transform: translateX(0); 
        }

        .toast-notification.success { background-color: var(--btn-primary-bg); }
        .toast-notification.error { background-color: #bf3737; color: #ffffff }
        .toast-notification.info { background-color: var(--bg-btn-secondary); color: var(--text-btn-secondary); }

        
        .btn-log-viewer {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }
        .btn-log-viewer:hover {
            background-color: var(--bg-file-label-hover);
        }
        .btn-log-viewer svg {
            width: 18px;
            height: 18px;
            stroke: var(--text-subtitle);
        }

        .log-popover {
            position: absolute;
            top: 100%;
            right: 0;
            width: 450px;
            max-width: 90vw;
            max-height: 400px;
            z-index: 100;
            margin-top: 8px;

            
            background-color: rgba(28, 28, 30, 0.9);
            color: #f0f0f0;

            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);

            padding: 15px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            
            font-size: 12px; 
            line-height: 1.6;

            opacity: 0;
            transform: translateY(-10px) scale(0.95);
            transform-origin: top right;
            transition: opacity 0.2s ease, transform 0.2s ease;
            pointer-events: none;
        }

        .log-popover::-webkit-scrollbar {
            width: 8px; 
        }

        .log-popover::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05); 
            border-radius: 10px;
        }

        .log-popover::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2); 
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        .log-popover::-webkit-scrollbar-thumb:hover {
            background-color: rgba(255, 255, 255, 0.4); 
        }
        
        .log-popover.visible {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto;
        }

        .log-popover p {
            margin: 0 0 5px;
            padding: 3px 8px;
            border-radius: 4px;
            word-break: break-all; 
        }

        .footer-info {
            text-align: center;
            padding: 20px 15px;
            color: var(--text-subtitle);
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        #update-log-popover {
            position: fixed;
            bottom: 60px; /* ÌôîÎ©¥ ÌïòÎã®ÏúºÎ°úÎ∂ÄÌÑ∞Ïùò Í±∞Î¶¨ */
            left: 50%;   /* ÌôîÎ©¥ ÏôºÏ™ΩÏóêÏÑú 50% ÏßÄÏ†ê */
            top: auto;   /* Í∏∞Ï°¥ top Ïä§ÌÉÄÏùº Ï¥àÍ∏∞Ìôî */
            right: auto; /* Í∏∞Ï°¥ right Ïä§ÌÉÄÏùº Ï¥àÍ∏∞Ìôî */
            width: 350px;
            transform-origin: bottom center;
            z-index: 1000;
            transform: translateX(-50%) translateY(10px) scale(0.95);
        }

        #update-log-popover.visible {
            transform: translateX(-50%) translateY(0) scale(1);
        }

        #advancedSettingsPanel {
            padding: 15px;
            border: 2px solid var(--border-main);
            border-radius: 10px;
            margin-top: 5px;
            background: var(--bg-main);
        }

        #persistent-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 20px;
            border-radius: 12px;
            color: var(--text-btn-primary);
            background-color: var(--btn-primary-bg);
            font-size: 16px;
            font-weight: 500;
            z-index: 9998;
            box-shadow: 0 8px 25px rgba(0,0,0,0.25);
            opacity: 0;
            transition: opacity 0.3s ease, bottom 0.3s ease;
            pointer-events: none;
        }

        #persistent-toast.show {
            opacity: 1;
            pointer-events: auto;
        }

        @media (max-width: 650px) {
            body {
                padding: 0;
            }
            .container {
                padding: 20px;
                margin: 10px;
                border-radius: 15px;
            }
            .theme-switcher {
                top: 20px; 
                right: 20px;
            }
            .header {
                margin-top: 35px; 
            }
            .title {
                font-size: 1.8em;
            }
            .section {
                padding: 15px;
            }
            .settings-grid {
                grid-template-columns: 1fr;
            }
            .button-group {
                flex-direction: column;
                align-items: stretch;
            }
            .btn {
                width: 100%;
                text-align: center;
            }
            .section-title-container {
                align-items: flex-start;
                gap: 10px;
            }
            .header-buttons {
                width: 100%;
                flex-direction: column;
            }
            .header-buttons .btn {
                margin-left: 0;
            }
            .api-key-actions .btn {
                width: auto;
                flex-shrink: 0;
            }
            .api-key-actions #connectionStatus {
                flex-grow: 1;
                text-align: center;
            }
            .input-with-button {
                flex-direction: column;
                align-items: stretch;
            }
            .input-with-button .btn-small {
                margin-left: 0;
            }
            .textarea-medium {
                min-height: 200px;
            }
            .action-button-container {
                justify-content: stretch;
            }
            .action-button-container .btn {
                 width: 100%;
            }
            .log-popover{
                width: 105%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        
        <div class="theme-switcher">
            <button class="theme-button" data-theme="original-pink" onclick="setTheme(this)" style="background-color: #ea6aa1;" title="Original Pink"></button>
            <button class="theme-button" data-theme="citrus-grove" onclick="setTheme(this)" style="background-color: #FDA769;" title="Citrus Grove"></button>
            <button class="theme-button" data-theme="modern-slate" onclick="setTheme(this)" style="background-color: #414F6B;" title="Modern Slate"></button>
            <button class="theme-button" data-theme="deep-forest" onclick="setTheme(this)" style="background-color: #5d7331;" title="Deep Forest"></button>
        </div>
        <div class="header">
            <h1 class="title">Í∞ÑÌé∏ ÌïúÍ∏ÄÌôî Î≤àÏó≠Í∏∞</h1>
            <p class="subtitle">Î¨¥Îã® Ï†ÑÏû¨ Î∞è ÏÉÅÏóÖÏ†Å Ïù¥Ïö© Í∏àÏßÄ</p>
        </div>
        
        <div class="section">
            <div class="section-title-container">
                <div class="section-title"><i data-feather="settings"></i> API ÏÑ§Ï†ï</div>
                <div class="header-buttons">
                    <button class="btn btn-success btn-small" onclick="saveSettings()"><i data-feather="download"></i> ÏÑ§Ï†ï Î∞±ÏóÖ</button>
                    <button class="btn btn-success btn-small" onclick="loadSettings()"><i data-feather="log-in"></i> Î∂àÎü¨Ïò§Í∏∞</button>
                </div>
            </div>
            <div class="settings-grid">
                <div class="input-group">
                    <label for="sourceLanguage">Î≤àÏó≠Ìï† Ïñ∏Ïñ¥</label>
                    <select id="sourceLanguage" onchange="updateLanguageLabels(); loadSelectedPrompt();">                    
                        <option value="chinese">üá®üá≥ Ï§ëÍµ≠Ïñ¥ ‚Üí ÌïúÍµ≠Ïñ¥</option>
                        <!-- <option value="english">üá∫üá∏ ÏòÅÏñ¥ ‚Üí ÌïúÍµ≠Ïñ¥ (ÏóÖÎç∞Ïù¥Ìä∏ ÏòàÏ†ï)</option>
                        <option value="japanese">üáØüáµ ÏùºÎ≥∏Ïñ¥ ‚Üí ÌïúÍµ≠Ïñ¥ (ÏóÖÎç∞Ïù¥Ìä∏ ÏòàÏ†ï)</option>
                        <option value="korean">üá∞üá∑ ÌïúÍµ≠Ïñ¥ ‚Üí Ïô∏Íµ≠Ïñ¥ (ÏóÖÎç∞Ïù¥Ìä∏ ÏòàÏ†ï)</option> -->
                    </select>
                </div>
                <div class="input-group">
                    <label for="apiProvider">API Ï†úÍ≥µÏûê</label>
                <select id="apiProvider" onchange="handleProviderChange()">
                        <option value="gemini">Google Gemini</option>
                        <option value="openai">OpenAI</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="apiModel">Î™®Îç∏ ÏÑ†ÌÉù</label>
                    <select id="apiModel" onchange="handleModelChange(this.value)">
                        <option value="gemini-2.5-pro">gemini-2.5-pro</option>
                        <option value="gemini-2.5-flash">gemini-2.5-flash</option>
                        <option value="gemini-2.0-flash">gemini-2.0-flash</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="apiKey">API ÌÇ§</label>
                    <input type="password" id="apiKey" placeholder="API ÌÇ§Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                    <div class="api-key-actions">
                        <button class="btn btn-primary btn-small btn-small-test" onclick="testConnection()"><i data-feather="zap"></i> ÌÖåÏä§Ìä∏</button>
                        <div id="connectionStatus" class="connection-status status-disconnected">Ïó∞Í≤∞ÎêòÏßÄ ÏïäÏùå</div>
                    </div>
                </div>
                <div class="input-group" style="grid-column: 1 / -1;">
                    <div class="settings-inline" style="justify-content: space-between; align-items: center; margin-bottom: 10px;">
                         <button class="btn-text-like" onclick="toggleAdvancedSettings()">
                            <i data-feather="sliders"></i> Í≥†Í∏â ÌååÎùºÎØ∏ÌÑ∞ ÏÑ§Ï†ï
                        </button>
                    </div>
                    <div id="advancedSettingsPanel" style="display: none;">
                        <div class="settings-grid">
                             <div class="input-group">
                                <label for="temperature">Ïò®ÎèÑ (Temperature)</label>
                                <input type="number" id="temperature" step="0.01" min="0" max="2" value="1">
                            </div>
                            <div class="input-group">
                                <label for="maxOutputTokens">ÏµúÎåÄ Ï∂úÎ†• ÌÜ†ÌÅ∞</label>
                                <input type="number" id="maxOutputTokens" step="1" min="1" value="65536">
                            </div>
                            <div class="input-group">
                                <label for="topP">Top P</label>
                                <input type="number" id="topP" step="0.01" min="0" max="1" value="0.98">
                            </div>
                            <div class="input-group">
                                <label for="topK">Top K</label>
                                <input type="number" id="topK" step="1" min="0" value="0">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title"><i data-feather="align-left"></i> Î≤àÏó≠ ÌîÑÎ°¨ÌîÑÌä∏</div>
            <div class="settings-grid settings-grid-margin">
                <div class="input-group">
                    <label for="promptSelect">Ï†ÄÏû•Îêú ÌîÑÎ°¨ÌîÑÌä∏</label>
                    <select id="promptSelect" onchange="loadSelectedPrompt()">
                        <option value="default">Í∏∞Î≥∏ ÌîÑÎ°¨ÌîÑÌä∏</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="promptName">ÌîÑÎ°¨ÌîÑÌä∏ Ïù¥Î¶Ñ</label>
                    <div class="input-with-button">
                        <input type="text" id="promptName" placeholder="ÏÉà ÌîÑÎ°¨ÌîÑÌä∏ Ïù¥Î¶Ñ">
                        <button class="btn btn-secondary btn-small" onclick="savePrompt()" title="ÌîÑÎ°¨ÌîÑÌä∏ Ï†ÄÏû•"><i data-feather="save"></i> Ï†ÄÏû•</button>
                    </div>
                </div>
            </div>
            <div class="input-group">
                <label for="translationPrompt">Î≤àÏó≠Ïö© ÌîÑÎ°¨ÌîÑÌä∏</label>
                <textarea id="translationPrompt" class="textarea-medium"></textarea>
            </div>
            <div class="settings-inline settings-inline-btn">
                <button class="btn btn-success btn-small" onclick="resetToDefault()" title="Í∏∞Î≥∏Í∞íÏúºÎ°ú ÎêòÎèåÎ¶¨Í∏∞"><i data-feather="refresh-ccw"></i> Í∏∞Î≥∏Í∞í</button>
                <button class="btn btn-success btn-small" onclick="importPrompt()" title="ÌîÑÎ°¨ÌîÑÌä∏ Í∞ÄÏ†∏Ïò§Í∏∞"><i data-feather="log-in"></i> Í∞ÄÏ†∏Ïò§Í∏∞</button>
                <button class="btn btn-success btn-small" onclick="exportPrompt()" title="ÌîÑÎ°¨ÌîÑÌä∏ ÎÇ¥Î≥¥ÎÇ¥Í∏∞"><i data-feather="log-out"></i> ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>
                <button class="btn btn-success btn-small" onclick="deletePrompt()" title="ÏÑ†ÌÉùÎêú ÌîÑÎ°¨ÌîÑÌä∏ ÏÇ≠Ï†ú"><i data-feather="trash"></i> ÏÇ≠Ï†ú</button>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title-container" id="input-text-header">
                <div class="section-title"><i data-feather="type"></i> ÏûÖÎ†• ÌÖçÏä§Ìä∏</div>
            </div>
            <div class="input-group">
                <div class="inputText-container">
                    <label for="inputText" id="input-text-label">Ï§ëÍµ≠Ïñ¥ ‚Üí ÌïúÍµ≠Ïñ¥</label>
                    <button class="btn-text-like" onclick="clearInputText()">ÎπÑÏö∞Í∏∞</button>
                </div>
                <textarea id="inputText" class="textarea-large" placeholder="ÌÖçÏä§Ìä∏ÎÇò ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." oninput="handleInputTextChange()"></textarea>
                <div id="inputTextCounter" class="char-counter">0Ïûê</div>
            </div>
            <div class="button-group">
                <label for="fileInput" class="file-label"><i data-feather="folder"></i> ÌååÏùº ÏÑ†ÌÉù (txt, json, jsonl, html, css)</label>
                <input type="file" id="fileInput" class="file-input" accept=".txt,.json,.jsonl,.html,.css" onchange="loadFile()">
                <button class="btn btn-primary" onclick="convertChinesePunctuation()" id="punctuationBtn" style="display: none;"><i data-feather="refresh-ccw"></i> Î¨∏Ïû•Î∂ÄÌò∏ Î≥ÄÌôò (Í∂åÏû•)</button>
                <button class="btn btn-primary" onclick="extractChinese()" id="extractBtn"><i data-feather="mouse-pointer"></i> Ï§ëÍµ≠Ïñ¥ Ï∂îÏ∂ú</button>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title" id="extracted-text-title"><i data-feather="file-text"></i> Ï∂îÏ∂úÎêú ÌÖçÏä§Ìä∏</div>
            <div class="input-group">
                <textarea id="extractedChinese" class="textarea-medium" placeholder="Ï∂îÏ∂úÎêú ÌÖçÏä§Ìä∏Í∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§..."></textarea>
                <div id="extractedChineseCounter" class="char-counter">0Ïûê</div>
            </div>
            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="action-button-container">
                <button class="btn btn-primary" onclick="translateText()" disabled><i data-feather="mouse-pointer"></i> Î≤àÏó≠ Ïã§Ìñâ</button>
            </div>
            <div id="extractStats" class="result-stats" style="display: none;">
                <strong>Ï∂îÏ∂ú Í≤∞Í≥º:</strong> <span id="extractCount">0</span>Í∞úÏùò <span id="languageType">Ï§ëÍµ≠Ïñ¥</span> Î¨∏ÏûêÏó¥Ïù¥ Î∞úÍ≤¨ÎêòÏóàÏäµÎãàÎã§.
            </div>
        </div>
        
        <div class="section">
            <div class="section-title-container" id="translation-result-header">
                <div class="section-title"><i data-feather="edit-3"></i> Î≤àÏó≠ Í≤∞Í≥º</div>
            </div>
            <div class="input-group">
                <textarea id="translationResult" class="textarea-medium" placeholder="Î≤àÏó≠ Í≤∞Í≥ºÍ∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§..." oninput="updateReplaceButtonState(); updateTranslationStatsFromTextarea(); toggleSpecialCharCheckButtonVisibility();"></textarea>
                <div id="translationResultCounter" class="char-counter">0Ïûê</div>
            </div>
            <div class="action-button-container button-group"> 
                <button class="btn btn-primary" onclick="replaceText()" disabled><i data-feather="mouse-pointer"></i> ÏùºÍ¥Ñ Î≥ÄÌôò</button>
                <button class="btn btn-success btn-small" onclick="importTranslationPairs()"><i data-feather="log-in"></i> Î∂àÎü¨Ïò§Í∏∞ (txt, json)</button>
                <button class="btn btn-success btn-small" onclick="exportTranslationPairs()"><i data-feather="log-out"></i> ÎÇ¥Î≥¥ÎÇ¥Í∏∞ (txt)</button>
                <button class="btn btn-secondary btn-small" onclick="validateSpecialCharacters()" id="validateSpecialCharsBtn" style="display: none;"><i data-feather="check-square"></i> ÌäπÏàòÎ¨∏Ïûê Í≤ÄÏÇ¨</button>
            </div>
            <div id="translationStats" class="result-stats" style="display: none;">
                <strong>Î≤àÏó≠ Í≤∞Í≥º:</strong> <span id="translationCount">0</span>Í∞úÏùò Î¨∏ÏûêÏó¥ ÏåçÏù¥ Î≤àÏó≠ÎêòÏóàÏäµÎãàÎã§.
            </div>
        </div>
        
        <div class="section section-title-last">
            <div class="section-title-container" id="final-text-header"> 
                <div class="section-title"><i data-feather="download"></i> Î≥ÄÌôòÎêú ÏµúÏ¢Ö ÌÖçÏä§Ìä∏</div>
            </div>
            <div class="input-group">
                
                <textarea id="finalResult" class="textarea-large" placeholder="Î≥ÄÌôòÎêú ÏµúÏ¢Ö Í≤∞Í≥ºÍ∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§..." oninput="validateFinalText()"></textarea>
                <div id="translationResultCounter" class="char-counter">0Ïûê</div>
            </div>
            
            <div class="button-group">
                <button class="btn btn-success" onclick="copyToClipboard()"><i data-feather="copy"></i> Î≥µÏÇ¨</button>
                <button class="btn btn-secondary" onclick="downloadResult()"><i data-feather="download"></i> ÌååÏùºÎ°ú Ï†ÄÏû•</button>
            </div>
            
            <div id="validationResult" class="result-stats" style="display: none;"></div>
        </div>
    </div>
    <div class="footer-info">
        <span>EasyKr V1.0.2 beta</span>
        <button class="btn-log-viewer" title="ÏóÖÎç∞Ïù¥Ìä∏ Î°úÍ∑∏ Î≥¥Í∏∞" onclick="toggleUpdateLog(event)">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather"><path d="M12 17s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
        </button>
    </div>

    <div id="update-log-popover" class="log-popover">
        <p style="text-align: center; color: #aaa;">ÏïÑÏßÅ ÏóÖÎç∞Ïù¥Ìä∏ Î°úÍ∑∏Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
    </div>
    <div id="toast-container"></div>
    <div id="persistent-toast"></div>
    <script src="https://unpkg.com/feather-icons"></script>
    <script>
        let extractedChineseArray = [];
        let currentLogData = [];
        let currentFileName = '';
        let currentFileExtension = '';

        const labels = {
            'chinese': 'Ï§ëÍµ≠Ïñ¥',
            'english': 'ÏòÅÏñ¥',
            'japanese': 'ÏùºÎ≥∏Ïñ¥',
            'korean': 'ÌïúÍµ≠Ïñ¥'
        };

        const DEFAULT_PROMPTS = {
            'chinese': '**[CONTEXT]**\nYou are a translation engine for an automated script. Your task is to perform a 1:1 substitution of Chinese text fragments with their Korean translations. The output will be parsed by a script that replaces the original Chinese text with your translation. This script relies on perfect, character-for-character preservation of all non-Chinese elements.\n\n**[ABSOLUTE GOLDEN RULE - THIS OVERRIDES ALL OTHER INSTRUCTIONS]**\n**DO NOT, under any circumstances, modify, \"fix\", or \"correct\" any punctuation, symbols, placeholders, or formatting.** Your primary goal is structural preservation, which is more important than linguistic naturalness. Treat these elements like code that must be copied perfectly.\n\n*   **Punctuation & Symbols:** Chinese punctuation like `„ÄÇ`, `ÔºÅ`, `Ôºü`, `Ôºö`, `„Äå„Äç` MUST remain identical. **DO NOT change `„ÄÇ` to `.` or `Ôºö` to `:`**.\n*   **Formatting & Placeholders:** `\\n`, `%s`, `{0}`, etc., MUST be kept in their exact positions.\n*   **Other Text:** English text, numbers, emojis MUST be left unchanged.\n\n**[OUTPUT FORMAT]**\n*   Return ONLY key-value pairs: `original_chinese=translated_korean`.\n*   One pair per line.\n*   NO headers, explanations, or conversational text. Any extra text will cause a fatal script error.\n\n**[TRANSLATION RULES]**\n1.  **1:1 Line Mapping:** Each input line must correspond to exactly one output line. DO NOT merge or split lines, even if it seems more natural.\n2.  **Contextual Translation:** Use adjacent lines for context to ensure the fragment translation is natural *within its given structure*, but do not alter the structure itself.\n3.  **Consistency:** Translate a specific Chinese term into the same Korean word throughout the request. (e.g., if \"Â≠ó‰Ωì\" is \"Í∏ÄÍº¥\", it must always be \"Í∏ÄÍº¥\").\n4.  **Glossary:** You MUST use the provided Korean translations for these terms:\n    [--- GLOSSARY ---]\n    prompt ‚Üí ÌîÑÎ°¨ÌîÑÌä∏\n    tavern, sillytavern ‚Üí Ïã§Î¶¨ÌÉúÎ≤à\n    world book, world info ‚Üí ÏõîÎìúÏù∏Ìè¨\n    character, ËßíËâ≤ ‚Üí Ï∫êÎ¶≠ÌÑ∞\n    Âêó(single) ‚Üí ?\n    [--- END OF GLOSSARY ---]\n5. Proper Nouns: Translate Chinese names phonetically into Korean. You must maintain strict consistency; the same Chinese name must always be translated into the exact same Korean spelling. (e.g., Âº†‰ºü ‚Üí Ïû•Ïõ®Ïù¥)\n\n**[Examples of PERFECT output]**\n*   Example 1 (Punctuation & Fragments):\n    *   Input: `ËØ∑ÈÄâÊã©‰∏Ä‰∏™ character„ÄÇ\n    *   Correct Output: `ËØ∑ÈÄâÊã©‰∏Ä‰∏™ character„ÄÇ=`Ï∫êÎ¶≠ÌÑ∞Î•º Ìïú Î™Ö ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî„ÄÇ\n    *   **WRONG Output:** `ËØ∑ÈÄâÊã©‰∏Ä‰∏™ character„ÄÇ=Ï∫êÎ¶≠ÌÑ∞Î•º Ìïú Î™Ö ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî.` (The \"„ÄÇ\" was incorrectly changed to \".\", and the location of \"`\" is changed)\n\n    *   Input: ËØ∑ÈÄâÊã©‰∏Ä‰∏™\\\\n‰Ω†ÊÉ≥ÂéªÁöÑÂú∞Êñπ\\\n    *   Correct Output: ËØ∑ÈÄâÊã©‰∏Ä‰∏™\\\\n‰Ω†ÊÉ≥ÂéªÁöÑÂú∞Êñπ\\=ÌïòÎÇòÎ•º ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî\\\\nÍ∞ÄÍ≥† Ïã∂ÏùÄ Ïû•ÏÜåÎ•º\\\n    *   **WRONG Output:** ËØ∑ÈÄâÊã©‰∏Ä‰∏™\\n‰Ω†ÊÉ≥ÂéªÁöÑÂú∞Êñπ=ÌïòÎÇòÎ•º ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî\\nÍ∞ÄÍ≥† Ïã∂ÏùÄ Ïû•ÏÜåÎ•º (The \"\\\\n\" was not supposed to be fixed)\n\n    *   Input: (‰ªÖÊ†ºÂºèÂåñÊòæÁ§∫/ÊèêÁ§∫ËØç\n    *   Correct Output: (‰ªÖÊ†ºÂºèÂåñÊòæÁ§∫/ÊèêÁ§∫ËØç=(ÏÑúÏãù ÏßÄÏ†ï ÌëúÏãú/ÌîÑÎ°¨ÌîÑÌä∏Îßå\n    *   **WRONG Output:** (‰ªÖÊ†ºÂºèÂåñÊòæÁ§∫/ÊèêÁ§∫ËØç=(ÏÑúÏãù ÏßÄÏ†ï ÌëúÏãú/ÌîÑÎ°¨ÌîÑÌä∏Îßå)\n\n*   Example 2 (Placeholder):\n    *   Input: [Error] Êó†Ê≥ïÊâæÂà∞Êñá‰ª∂ %s\n    *   Correct Output: [Error] Êó†Ê≥ïÊâæÂà∞Êñá‰ª∂ %s=[Error] ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§ %s\n    *   **WRONG Output:** [Error] Êó†Ê≥ïÊâæÂà∞Êñá‰ª∂ %s=[Error] ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. (The \"%s\" was not supposed to be fixed, and \".\" was not supposed to be added)\n\n*   Example 3 (Multi-lines):\n    *   Input:\n    Â∞ÜÈÄâ‰∏≠ÁöÑ${n\n    length}Êù°Ê∂àÊÅØÁßªÂä®Âà∞Âì™‰∏ÄÊ•º‰πãÂâç\n    *   Correct Output:\n    Â∞ÜÈÄâ‰∏≠ÁöÑ${n=ÏÑ†ÌÉùÌïú ${n\n    length}Êù°Ê∂àÊÅØÁßªÂä®Âà∞Âì™‰∏ÄÊ•º‰πãÂâç=length}Í∞úÏùò Î©îÏãúÏßÄÎ•º Î™á Î≤àÏß∏ Î©îÏãúÏßÄ ÏïûÏúºÎ°ú Ïù¥ÎèôÌïòÏãúÍ≤†ÏäµÎãàÍπå\n\n**Ï£ºÏùò: `„ÄÇ`, `Ôºö` ÏôÄ Í∞ôÏùÄ Ï§ëÍµ≠Ïñ¥ Î¨∏Ïû• Î∂ÄÌò∏Îäî Ï†àÎåÄÎ°ú ÌïúÍµ≠Ïñ¥ `.`Ïù¥ÎÇò `:`ÏúºÎ°ú Î∞îÍæ∏ÏßÄ ÎßàÏÑ∏Ïöî. ÏûÖÎ†•Ïóê ÏûàÎäî Í∑∏ÎåÄÎ°ú Ï∂úÎ†•Ïóê Ìè¨Ìï®Ìï¥Ïïº Ìï©ÎãàÎã§. Ïù¥ Í∑úÏπôÏùÄ Î≤àÏó≠Ïùò ÏûêÏó∞Ïä§Îü¨ÏõÄÎ≥¥Îã§ Ï§ëÏöîÌï©ÎãàÎã§.**\n\nNow, translate the following Chinese text fragments into Korean, strictly following all the rules above: ',
            'english': 'Please translate the English text fragments into Korean. Keep formatting and return as: original_english=translated_korean',
            'japanese': 'Please translate the Japanese text fragments into Korean. Convert Japanese punctuation to Korean equivalents. Return as: original_japanese=translated_korean',
            'korean': 'Please translate the Korean text fragments into the target foreign language. Return as: original_korean=translated_target'
        };

        const LOW_SPEC_MODELS = {
            // 'Î™®Îç∏ Ïù¥Î¶Ñ': { maxOutput: ÏµúÎåÄÏ∂úÎ†•ÌÜ†ÌÅ∞, safeInputChars: ÏïàÏ†ÑÌïúÏûÖÎ†•Í∏ÄÏûêÏàò }
            'gemini-2.0-flash': { maxOutput: 8192, safeInputChars: 25000 },
            'gemini-2.0-flash-001': { maxOutput: 8192, safeInputChars: 25000 },
            'gpt-4o': { maxOutput: 16384, safeInputChars: 25000 },
            'chatgpt-4o-latest': { maxOutput: 16384, safeInputChars: 50000 },
            'gpt-4o-mini': { maxOutput: 16384, safeInputChars: 50000 },
            'gpt-5-chat-latest': { maxOutput: 16384, safeInputChars: 50000 },
        };

        const OPENAI_MODELS_NO_TOP_P = [
            'gpt-5', 'gpt-5-mini', 'gpt-5-chat', 'gpt-5-nano',
            'gpt-4.1', 'gpt-4.1-mini', 'gpt-4.1-nano'
        ];

        const DEFAULT_MAX_OUTPUT = 65536;

        const API_MODELS = {
            'gemini': [
                'gemini-2.5-pro', 'gemini-2.5-flash', 'gemini-2.0-flash'
            ],
            'openai': [
                'gpt-5', 'gpt-5-mini', 'gpt-5-chat-latest', 'gpt-5-nano', 
                'gpt-4o', 'chatgpt-4o-latest', 'gpt-4o-mini', 
                'gpt-4.1', 'gpt-4.1-mini', 'gpt-4.1-nano'
            ]
        };

        function loadApiKeyForProvider() {
            const provider = document.getElementById('apiProvider').value;
            const apiKeyStorageKey = `${provider}ApiKey`; // e.g., 'geminiApiKey' or 'openaiApiKey'
            
            document.getElementById('apiKey').value = localStorage.getItem(apiKeyStorageKey) || '';
        }

        function updateCharCounter(textareaId) {
            const textarea = document.getElementById(textareaId);
            const counter = document.getElementById(textareaId + 'Counter');
            if (textarea && counter) {
                // Ïà´ÏûêÎ•º ÏùΩÍ∏∞ ÏâΩÍ≤å 3ÏûêÎ¶¨ÎßàÎã§ ÏΩ§Îßà(,)Î•º Ï∂îÍ∞ÄÌï©ÎãàÎã§.
                const count = textarea.value.length.toLocaleString();
                counter.textContent = `${count}Ïûê`;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (history.scrollRestoration) {
                history.scrollRestoration = 'manual';
            }

            // 1. UI ÏöîÏÜå Ï±ÑÏö∞Í∏∞
            updatePromptSelect();

            // 2. ÏÑ§Ï†ï Í∞í Î∂àÎü¨Ïò§Í∏∞
            const savedProvider = localStorage.getItem('apiProvider') || 'gemini';
            const savedModel = localStorage.getItem('apiModel') || (savedProvider === 'openai' ? 'gpt-4o' : 'gemini-2.5-pro');
            const savedPrompt = localStorage.getItem('selectedPrompt') || 'default';

            // 3. UIÏóê ÏÑ§Ï†ï Ï†ÅÏö©
            document.getElementById('apiProvider').value = savedProvider;
            handleProviderChange(); // Î™®Îç∏ Î™©Î°ù Ï±ÑÏö∞Í∏∞ Î∞è Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ Ïã§Ìñâ
            
            const modelSelect = document.getElementById('apiModel');
            if (Array.from(modelSelect.options).some(opt => opt.value === savedModel)) {
                modelSelect.value = savedModel;
            }
            
            const promptSelect = document.getElementById('promptSelect');
            if (promptSelect.querySelector(`option[value="${savedPrompt}"]`)) {
                promptSelect.value = savedPrompt;
            }
            
            loadApiKeyForProvider();

            document.getElementById('sourceLanguage').value = localStorage.getItem('sourceLanguage') || 'chinese';
            document.getElementById('temperature').value = localStorage.getItem('temperature') || '1';
            document.getElementById('maxOutputTokens').value = localStorage.getItem('maxOutputTokens') || DEFAULT_MAX_OUTPUT;
            document.getElementById('topP').value = localStorage.getItem('topP') || '0.98';
            document.getElementById('topK').value = localStorage.getItem('topK') || '0';

            // 4. UI ÏóÖÎç∞Ïù¥Ìä∏ Î∞è ÏµúÏ¢Ö ÏûëÏóÖ
            loadSelectedPrompt();
            updateLanguageLabels();
            handleModelChange(modelSelect.value); // Ïó¨Í∏∞ÏÑú ÌïúÎ≤à Îçî UIÎ•º ÏóÖÎç∞Ïù¥Ìä∏ Ìï¥Ï§çÎãàÎã§.
            
            // [ÏàòÏ†ï] Ï§ëÎ≥µ Ìò∏Ï∂úÎêòÎçò Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ Î∂ÄÎ∂ÑÏùÑ ÏÇ≠Ï†úÌñàÏäµÎãàÎã§.
            // handleProviderChange()Í∞Ä Ïù¥ÎØ∏ Ïã§ÌñâÌñàÍ∏∞ ÎïåÎ¨∏Ïóê ÌïÑÏöî ÏóÜÏäµÎãàÎã§.

            // 5. ÏÑ§Ï†ï Ï†ÄÏû• Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ïó∞Í≤∞
            const settingsToWatch = [
                'sourceLanguage', 'apiProvider', 'apiModel', 'apiKey', 'promptSelect',
                'temperature', 'maxOutputTokens', 'topP', 'topK'
            ];
            settingsToWatch.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', saveAllSettingsToStorage);
                }
            });
            const textareaIds = ['inputText', 'extractedChinese', 'translationResult', 'finalResult'];

            textareaIds.forEach(id => {
                const textarea = document.getElementById(id);
                if (textarea) {
                    // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞ Í∏ÄÏûê Ïàò Í≥ÑÏÇ∞
                    updateCharCounter(id);

                    // Í∞Å ÌÖçÏä§Ìä∏ ÏòÅÏó≠Ïóê ÏûÖÎ†• Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
                    textarea.addEventListener('input', () => updateCharCounter(id));
                }
            });
        });

        function saveAllSettingsToStorage() {
            const provider = document.getElementById('apiProvider').value;
            const apiKeyStorageKey = `${provider}ApiKey`;

            // [ÏàòÏ†ï] Ï†úÍ≥µÏûêÏóê ÎßûÎäî ÌÇ§ Ïù¥Î¶ÑÏúºÎ°ú API ÌÇ§Î•º Ï†ÄÏû•Ìï©ÎãàÎã§.
            localStorage.setItem(apiKeyStorageKey, document.getElementById('apiKey').value);

            // ÎÇòÎ®∏ÏßÄ ÏÑ§Ï†ï Ï†ÄÏû•
            localStorage.setItem('sourceLanguage', document.getElementById('sourceLanguage').value);
            localStorage.setItem('apiProvider', document.getElementById('apiProvider').value);
            localStorage.setItem('apiModel', document.getElementById('apiModel').value);
            localStorage.setItem('selectedPrompt', document.getElementById('promptSelect').value);
            
            localStorage.setItem('temperature', document.getElementById('temperature').value);
            localStorage.setItem('maxOutputTokens', document.getElementById('maxOutputTokens').value);
            localStorage.setItem('topP', document.getElementById('topP').value);
            localStorage.setItem('topK', document.getElementById('topK').value);
        }

        function toggleAdvancedSettings() {
            const panel = document.getElementById('advancedSettingsPanel');
            const isVisible = panel.style.display === 'block';
            panel.style.display = isVisible ? 'none' : 'block';
        }

        /**
         * @param {string} message - ÌëúÏãúÌï† Î©îÏãúÏßÄ
         * @param {string} type - 'success', 'error', 'info' ÎòêÎäî 'persistent'
         * @param {boolean} forceClose - (persistent Ï†ÑÏö©) Í∞ïÏ†úÎ°ú Îã´ÏùÑÏßÄ Ïó¨Î∂Ä
         */
        function showToast(message, type = 'info', forceClose = false) {

            const persistentToast = document.getElementById('persistent-toast');
            if (type === 'persistent') {
                if (forceClose) {
                    persistentToast.classList.remove('show');
                } else {
                    persistentToast.textContent = message;
                    persistentToast.classList.add('show');
                }
                return;
            }

            const container = document.getElementById('toast-container');
            if (!container) return; 

            const toast = document.createElement('div');
            toast.className = `toast-notification ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 5000);
        }

        function toggleSpecialCharCheckButtonVisibility() {
            const translationResult = document.getElementById('translationResult').value;
            const validateBtn = document.getElementById('validateSpecialCharsBtn');
            if (validateBtn) {
                validateBtn.style.display = translationResult.trim() ? 'inline-block' : 'none';
            }
        }

        function clearInputText() {
            if (confirm("ÏûÖÎ†•Ï∞ΩÏùò Î™®Îì† ÎÇ¥Ïö©ÏùÑ ÏßÄÏö∞ÏãúÍ≤†ÏäµÎãàÍπå?")) {
                document.getElementById('inputText').value = '';
                updateReplaceButtonState();
                updateInputTextLabel(); 
                showToast('ÏûÖÎ†•Ï∞ΩÏùÑ ÎπÑÏõ†ÏäµÎãàÎã§.');
            }
        }
        
        function updateLanguageLabels() {
            const sourceLanguage = document.getElementById('sourceLanguage').value;
            const inputLabel = document.getElementById('input-text-label');
            const extractedLabel = document.getElementById('extracted-text-title');
            const punctuationBtn = document.getElementById('punctuationBtn');
            const languageType = document.getElementById('languageType');
            const extractBtn = document.getElementById('extractBtn'); 
            
            const targetLang = sourceLanguage === 'korean' ? 'Ïô∏Íµ≠Ïñ¥' : 'ÌïúÍµ≠Ïñ¥';

            if (inputLabel) {
                inputLabel.textContent = `${labels[sourceLanguage]} ‚Üí ${targetLang}`;
            }
            
            if (extractBtn) {
                
                extractBtn.innerHTML = `<i data-feather="mouse-pointer"></i> ${labels[sourceLanguage]} Ï∂îÏ∂ú`;
            }
            
            if (extractedLabel) {
                if (sourceLanguage === 'korean') {
                    extractedLabel.innerHTML = `<i data-feather="file-text"></i> Ï∂îÏ∂úÎêú ÌïúÍµ≠Ïñ¥`;
                } else {
                    extractedLabel.innerHTML = `<i data-feather="file-text"></i> Ï∂îÏ∂úÎêú ${labels[sourceLanguage]}`;
                }
            }
            
            if (languageType) {
                languageType.textContent = labels[sourceLanguage];
            }

            if (sourceLanguage === 'chinese') {
                punctuationBtn.style.display = 'inline-block';
            } else {
                punctuationBtn.style.display = 'none';
            }
            
            feather.replace();
            updateInputTextLabel();
        }

        
        function updateExtractStats(count) {
            const extractCount = document.getElementById('extractCount');
            const extractStats = document.getElementById('extractStats');
            
            if (extractCount) {
                extractCount.textContent = count;
            }
            
            if (extractStats && count > 0) {
                extractStats.style.display = 'block';
            }
        }

        function updatePromptSelect() {
            const select = document.getElementById('promptSelect');
            const savedPrompts = JSON.parse(localStorage.getItem('savedPrompts') || '{}');
            
            select.innerHTML = '<option value="default">Í∏∞Î≥∏ ÌîÑÎ°¨ÌîÑÌä∏</option>';
            
            for (const [name, prompt] of Object.entries(savedPrompts)) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            }
        }

        function loadSelectedPrompt() {
            const select = document.getElementById('promptSelect');
            const selectedPrompt = select.value;
            const sourceLanguage = document.getElementById('sourceLanguage').value;
            const promptTextarea = document.getElementById('translationPrompt');
            
            if (selectedPrompt === 'default') {
                promptTextarea.value = DEFAULT_PROMPTS[sourceLanguage] || DEFAULT_PROMPTS['chinese'];
            } else {
                const savedPrompts = JSON.parse(localStorage.getItem('savedPrompts') || '{}');
                promptTextarea.value = savedPrompts[selectedPrompt] || DEFAULT_PROMPTS[sourceLanguage];
            }
            
            localStorage.setItem('selectedPrompt', selectedPrompt);
        }

        function resetToDefault() {
            const sourceLanguage = document.getElementById('sourceLanguage').value;
            document.getElementById('translationPrompt').value = DEFAULT_PROMPTS[sourceLanguage] || DEFAULT_PROMPTS['chinese'];
            document.getElementById('promptSelect').value = 'default';
        }

        function savePrompt() {
            const name = document.getElementById('promptName').value.trim();
            const prompt = document.getElementById('translationPrompt').value;
            
            if (!name) {
                alert('ÌîÑÎ°¨ÌîÑÌä∏ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            const savedPrompts = JSON.parse(localStorage.getItem('savedPrompts') || '{}');
            savedPrompts[name] = prompt;
            localStorage.setItem('savedPrompts', JSON.stringify(savedPrompts));
            
            updatePromptSelect();
            document.getElementById('promptSelect').value = name;
            document.getElementById('promptName').value = ''; 
            showToast('ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
        }

        function exportPrompt() {
            const select = document.getElementById('promptSelect');
            const selectedName = select.value;

            const savedPrompts = JSON.parse(localStorage.getItem('savedPrompts') || '{}');
            const promptToExport = savedPrompts[selectedName];

            if (!promptToExport) {
                alert('ÏÑ†ÌÉùÎêú ÌîÑÎ°¨ÌîÑÌä∏Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            const dataStr = JSON.stringify({ name: selectedName, prompt: promptToExport }, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            
            linkElement.setAttribute('download', `EasyKr_prompt_${selectedName}.json`);
            linkElement.click();
        }

        function importPrompt() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            let { name, prompt } = data;

                            if (!name || !prompt) {
                                throw new Error('ÌååÏùº ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§. "name"Í≥º "prompt" ÏÜçÏÑ±Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
                            }

                            const savedPrompts = JSON.parse(localStorage.getItem('savedPrompts') || '{}');
                            let newName = name;
                            let counter = 1;
                            
                            while (savedPrompts[newName]) {
                                newName = `${name} (${counter})`;
                                counter++;
                            }
                            
                            savedPrompts[newName] = prompt;
                            localStorage.setItem('savedPrompts', JSON.stringify(savedPrompts));

                            updatePromptSelect();
                            document.getElementById('promptSelect').value = newName;
                            loadSelectedPrompt(); 
                            
                            if (newName !== name) {
                                showToast(`'${name}' ÌîÑÎ°¨ÌîÑÌä∏Îäî Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÏó¨ '${newName}'ÏúºÎ°ú Ï†ÄÏû•ÌñàÏäµÎãàÎã§.`, 'info');
                            } else {
                                showToast(`'${newName}' ÌîÑÎ°¨ÌîÑÌä∏Î•º ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î∂àÎü¨ÏôîÏäµÎãàÎã§.`, 'success');
                            }

                        } catch (error) {
                            alert(`ÌîÑÎ°¨ÌîÑÌä∏ ÌååÏùºÏùÑ ÏùΩÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${error.message}`);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function updateReplaceButtonState() {
            const inputText = document.getElementById('inputText').value;
            const translationResult = document.getElementById('translationResult').value;
            const replaceBtn = document.querySelector('button[onclick="replaceText()"]');
            
            
            replaceBtn.disabled = !(inputText.trim() && translationResult.trim());
        }

        function chunkArray(array, chunkSize) {
            const chunks = [];
            for (let i = 0; i < array.length; i += chunkSize) {
                chunks.push(array.slice(i, i + chunkSize));
            }
            return chunks;
        }

        function getGenerationConfig() {
            return {
                temperature: parseFloat(document.getElementById('temperature').value),
                maxOutputTokens: parseInt(document.getElementById('maxOutputTokens').value),
                topP: parseFloat(document.getElementById('topP').value),
                topK: parseInt(document.getElementById('topK').value),
            };
        }

        function handleModelChange(selectedModel) {
            const maxOutputTokensInput = document.getElementById('maxOutputTokens');
            const isLowSpec = LOW_SPEC_MODELS.hasOwnProperty(selectedModel);

            if (isLowSpec) {
                const spec = LOW_SPEC_MODELS[selectedModel];
                
                maxOutputTokensInput.value = spec.maxOutput;

                showToast(`'${selectedModel}'ÏùÄ ÏµúÎåÄ Ï∂úÎ†•Ïù¥ ${spec.maxOutput} ÌÜ†ÌÅ∞ÏúºÎ°ú Ï†úÌïúÎê©ÎãàÎã§. Î≤àÏó≠ ÏöîÏ≤≠Ïù¥ ÏûêÎèôÏúºÎ°ú Î∂ÑÌï†Îê©ÎãàÎã§.`, 'info');

            } else {
                const savedValue = localStorage.getItem('maxOutputTokens');
                maxOutputTokensInput.value = savedValue && !LOW_SPEC_MODELS.hasOwnProperty(localStorage.getItem('apiModel')) ? savedValue : DEFAULT_MAX_OUTPUT;
            }

            localStorage.setItem('apiModel', selectedModel);
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement.classList.contains('status-connected')) {
                statusElement.textContent = `Ïó∞Í≤∞ ÏÑ±Í≥µ (${selectedModel})`;
            }

            updateApiSpecificParamsUI();
        }

        function updateApiSpecificParamsUI() {
            const apiProvider = document.getElementById('apiProvider').value;
            const selectedModel = document.getElementById('apiModel').value;

            const topKInput = document.getElementById('topK');
            const topKLabel = document.querySelector('label[for="topK"]');
            const topPInput = document.getElementById('topP');
            const topPLabel = document.querySelector('label[for="topP"]');

            // Top K Ï≤òÎ¶¨ (Ï†úÍ≥µÏûê Í∏∞Ï§Ä)
            if (apiProvider === 'openai') {
                topKInput.disabled = true;
                topKLabel.style.opacity = '0.5';
            } else {
                topKInput.disabled = false;
                topKLabel.style.opacity = '1';
            }

            // Top P Ï≤òÎ¶¨ (ÌäπÏ†ï Î™®Îç∏ Í∏∞Ï§Ä)
            if (apiProvider === 'openai' && OPENAI_MODELS_NO_TOP_P.includes(selectedModel)) {
                topPInput.disabled = true;
                topPLabel.style.opacity = '0.5';
            } else {
                topPInput.disabled = false;
                topPLabel.style.opacity = '1';
            }
        }

        function handleProviderChange() {
            const provider = document.getElementById('apiProvider').value;
            const modelSelect = document.getElementById('apiModel');
            const models = API_MODELS[provider] || [];

            modelSelect.innerHTML = '';

            models.forEach(modelName => {
                const option = document.createElement('option');
                option.value = modelName;
                option.textContent = modelName;
                modelSelect.appendChild(option);
            });

            if (models.length > 0) {
                modelSelect.value = models[0];
                handleModelChange(models[0]);
            }
            
            updateApiSpecificParamsUI(); // Top K Îì± UI ÏóÖÎç∞Ïù¥Ìä∏
            loadApiKeyForProvider();     // ÏÉà Ï†úÍ≥µÏûêÏóê ÎßûÎäî API ÌÇ§Î•º inputÏóê Î∂àÎü¨Ïò§Í∏∞

            if (document.getElementById('apiKey').value) {
                testConnection();
            } else {
                const statusElement = document.getElementById('connectionStatus');
                statusElement.className = 'connection-status status-disconnected';
                statusElement.textContent = 'Ïó∞Í≤∞ÎêòÏßÄ ÏïäÏùå';
            }
        }

        function chunkLinesByCharLimit(lines, maxChars) {
            if (lines.join('\n').length <= maxChars) {
                return [lines];
            }

            const chunks = [];
            let currentChunk = [];
            let currentChars = 0;

            lines.forEach(line => {
                const lineLength = line.length + 1;

                if (lineLength > maxChars) {
                    if (currentChunk.length > 0) {
                        chunks.push(currentChunk);
                        currentChunk = [];
                        currentChars = 0;
                    }
                    chunks.push([line]);
                    console.warn(`[Î≤àÏó≠ Í≤ΩÍ≥†] Ìïú Ï§ÑÏùò Í∏∏Ïù¥Í∞Ä ${line.length}ÏûêÎ°ú ÎÑàÎ¨¥ ÍπÅÎãàÎã§. Ïù¥ Î∂ÄÎ∂ÑÏóêÏÑú Î≤àÏó≠ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌï† Ïàò ÏûàÏäµÎãàÎã§.`);
                    return;
                }

                if (currentChars + lineLength > maxChars) {
                    chunks.push(currentChunk);
                    currentChunk = [line];
                    currentChars = lineLength;
                } else {
                    currentChunk.push(line);
                    currentChars += lineLength;
                }
            });
            
            if (currentChunk.length > 0) {
                chunks.push(currentChunk);
            }

            return chunks;
        }

        async function translateText() {
            const apiKey = document.getElementById('apiKey').value;
            const model = document.getElementById('apiModel').value;
            const prompt = document.getElementById('translationPrompt').value;
            const apiProvider = document.getElementById('apiProvider').value;

            if (!apiKey) {
                showToast('API ÌÇ§Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }
            if (extractedChineseArray.length === 0) {
                const langName = labels[document.getElementById('sourceLanguage').value] || 'Ïô∏Íµ≠Ïñ¥';
                showToast(`${langName}Î•º Î®ºÏ†Ä Ï∂îÏ∂úÌï¥Ï£ºÏÑ∏Ïöî.`, 'info');
                return;
            }

            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const translationResultTextarea = document.getElementById('translationResult');
            
            progressBar.style.display = 'block';
            progressFill.style.width = '0%';
            translationResultTextarea.value = '';
            translationResultTextarea.disabled = true;

            try {
                const promptLength = (prompt || '').length;
                let charLimit = 15000;
                if (LOW_SPEC_MODELS.hasOwnProperty(model)) {
                    charLimit = LOW_SPEC_MODELS[model].safeInputChars;
                }
                const effectiveCharLimit = charLimit - promptLength - 300;

                const chunks = chunkLinesByCharLimit(extractedChineseArray, effectiveCharLimit);
                const totalChunks = chunks.length;

                for (let chunkIndex = 0; chunkIndex < chunks.length; chunkIndex++) {
                    const chunkLines = chunks[chunkIndex];
                    const textToTranslate = chunkLines.join('\n');
                                        
                    if (totalChunks > 1) {
                        showToast(`Î≤àÏó≠ Ï§ë... (${chunkIndex + 1}/${totalChunks}Î≤àÏß∏ ÏöîÏ≤≠)`, 'persistent');
                    } else {
                        showToast('Î≤àÏó≠ Ï§ë...', 'persistent');
                    }
                    progressFill.style.width = `${((chunkIndex + 0.5) / totalChunks) * 100}%`;

                    let apiEndpoint = '';
                    let requestBody = {};
                    let requestHeaders = { 'Content-Type': 'application/json' };

                    if (apiProvider === 'openai') {
                        apiEndpoint = 'https://api.openai.com/v1/chat/completions';
                        requestHeaders['Authorization'] = `Bearer ${apiKey}`;
                        
                        requestBody = {
                            model: model,
                            messages: [
                                { role: 'system', content: prompt },
                                { role: 'user', content: textToTranslate }
                            ],
                            temperature: parseFloat(document.getElementById('temperature').value),
                        };

                        // [ÏàòÏ†ï] top_p ÌååÎùºÎØ∏ÌÑ∞Î•º Ï°∞Í±¥Î∂ÄÎ°ú Ï∂îÍ∞ÄÌï©ÎãàÎã§.
                        if (!OPENAI_MODELS_NO_TOP_P.includes(model)) {
                            requestBody.top_p = parseFloat(document.getElementById('topP').value);
                        }

                        const modelsUsingNewParam = ['gpt-5', 'gpt-5-mini', 'gpt-5-chat', 'gpt-5-nano', 'gpt-4.1', 'gpt-4.1-mini', 'gpt-4.1-nano'];
                        const maxTokensValue = parseInt(document.getElementById('maxOutputTokens').value);

                        if (modelsUsingNewParam.includes(model)) {
                            requestBody.max_completion_tokens = maxTokensValue;
                        } else {
                            requestBody.max_tokens = maxTokensValue;
                        }

                    } else {
                        apiEndpoint = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                        const fullPrompt = prompt + '\n\n' + textToTranslate;
                        requestBody = {
                            contents: [{ parts: [{ text: fullPrompt }] }],
                            generationConfig: getGenerationConfig()
                        };
                    }

                    const response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: requestHeaders,
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        const errorMessage = errorData.error?.message || response.statusText;
                        throw new Error(`API Ïò§Î•ò (ÏöîÏ≤≠ ${chunkIndex + 1}/${totalChunks}): ${errorMessage}`);
                    }

                    const data = await response.json();
                    
                    let translatedText = '';
                    if (apiProvider === 'openai') {
                        translatedText = data.choices?.[0]?.message?.content || '';
                    } else {
                        translatedText = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                    }
                    
                    translationResultTextarea.value += translatedText;
                    
                    if (chunkIndex < totalChunks - 1) {
                        translationResultTextarea.value += '\n';
                    }
                    translationResultTextarea.scrollTop = translationResultTextarea.scrollHeight;

                    progressFill.style.width = `${((chunkIndex + 1) / totalChunks) * 100}%`;
                }

                updateTranslationStatsFromTextarea();
                updateReplaceButtonState();
                
                setTimeout(() => { progressBar.style.display = 'none'; }, 1000);
                showToast('', 'persistent', true); 
                
                const finalPairCount = translationResultTextarea.value.split('\n').filter(line => line.includes('=')).length;
                showToast(`Ï¥ù ${finalPairCount}Í∞ú Ìï≠Î™©Ïù¥ Î≤àÏó≠ÎêòÏóàÏäµÎãàÎã§.`, 'success');
                toggleSpecialCharCheckButtonVisibility();

            } catch (error) {
                progressBar.style.display = 'none';
                showToast('', 'persistent', true);
                showToast(`${error.message}`, 'error');
                console.error(error);
            } finally {
                translationResultTextarea.disabled = false;
            }
        }

        function replaceText() {
            
            currentLogData = [];
            removeLogUI();

            const inputText = document.getElementById('inputText').value;
            const translationResultText = document.getElementById('translationResult').value;

            if (!inputText.trim()) {
                alert('Î≥ÄÌôòÌï† ÎÇ¥Ïö©Ïù¥ ÏûàÎäî "ÏûÖÎ†• ÌÖçÏä§Ìä∏" Ï∞ΩÏùÑ Î®ºÏ†Ä Ï±ÑÏõåÏ£ºÏÑ∏Ïöî.');
                return;
            }
            
            if (translationResultText.trim()) {
                const hasBeenTranslatedViaApi = extractedChineseArray.length > 0; 
                if (!hasBeenTranslatedViaApi) {
                    if (!confirm('LLM Î≤àÏó≠Ïù¥ Ïã§ÌñâÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. ÌòÑÏû¨ "Î≤àÏó≠ Í≤∞Í≥º" Ï∞ΩÏóê ÏßÅÏ†ë ÏûÖÎ†•Îêú ÎÇ¥Ïö©ÏúºÎ°ú Î≥ÄÌôòÏùÑ ÏßÑÌñâÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                        return;
                    } 
                }
            }

            if (!translationResultText.trim()) {
                alert('"Î≤àÏó≠ Í≤∞Í≥º" Ï∞ΩÏù¥ ÎπÑÏñ¥ÏûàÏñ¥ Î≥ÄÌôòÏùÑ ÏßÑÌñâÌï† Ïàò ÏóÜÏäµÎãàÎã§. Î≤àÏó≠ÏùÑ Ïã§ÌñâÌïòÍ±∞ÎÇò, "ÏõêÎ≥∏=Î≤àÏó≠" ÌòïÏãùÏúºÎ°ú ÎÇ¥Ïö©ÏùÑ ÏßÅÏ†ë ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            const lines = translationResultText.split('\n');
            const allPairs = [];
            let ignoreFormatErrors = false; 
            let skippedLines = 0; 

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line === '') continue; 

                const equalIndex = line.indexOf('=');
                const isInvalidPair = equalIndex === -1 || line.substring(equalIndex + 1).trim().length === 0;

                if (isInvalidPair) {
                    skippedLines++;
                    if (!ignoreFormatErrors) {
                        const proceed = confirm(
                            `Ïò§Î•ò: "Î≤àÏó≠ Í≤∞Í≥º" Ï∞ΩÏùò ${i + 1}Î≤àÏß∏ Ï§Ñ ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.\n\n[ÎÇ¥Ïö©]\n${line}\n\n"ÏõêÎ≥∏=Î≤àÏó≠" ÌòïÏãùÏù¥ ÏïÑÎãàÍ±∞ÎÇò Î≤àÏó≠ ÎÇ¥Ïö©Ïù¥ ÎπÑÏñ¥ÏûàÏäµÎãàÎã§. Ïù¥ Ï§ÑÍ≥º Ïù¥ÌõÑÏùò Î™®Îì† ÌòïÏãù Ïò§Î•òÎ•º Î¨¥ÏãúÌïòÍ≥† Î≥ÄÌôòÏùÑ Í≥ÑÏÜçÌïòÏãúÍ≤†ÏäµÎãàÍπå?`
                        );

                        if (proceed) {
                            ignoreFormatErrors = true;
                            console.warn(`[ÏùºÍ¥Ñ Î≥ÄÌôò Í≤ΩÍ≥†] ÏÇ¨Ïö©ÏûêÍ∞Ä ÌòïÏãù Ïò§Î•òÎ•º Î¨¥ÏãúÌïòÍ∏∞Î°ú ÏÑ†ÌÉùÌñàÏäµÎãàÎã§. ${i + 1}Î≤àÏß∏ Ï§ÑÏùÑ Í±¥ÎÑàÎúÅÎãàÎã§: "${line}"`);
                            continue;
                        } else {
                            showToast('ÌòïÏãù Ïò§Î•òÎ°ú Ïù∏Ìï¥ Î≥ÄÌôòÏù¥ Ï§ëÎã®ÎêòÏóàÏäµÎãàÎã§.', 'error');
                            return;
                        }
                    } else {
                        console.warn(`[ÏùºÍ¥Ñ Î≥ÄÌôò Í≤ΩÍ≥†] ÌòïÏãù Ïò§Î•òÍ∞Ä ÏûàÎäî ${i + 1}Î≤àÏß∏ Ï§ÑÏùÑ Í±¥ÎÑàÎúÅÎãàÎã§: "${line}"`);
                        continue;
                    }
                } else { 
                    const original = line.substring(0, equalIndex);
                    const translation = line.substring(equalIndex + 1);
                    
                    allPairs.push({
                        original: original,
                        translation: translation,
                        length: original.length
                    });
                }
            }

            if (skippedLines > 0 && !ignoreFormatErrors) {
            } else if (skippedLines > 0 && ignoreFormatErrors) {
                showToast(`${skippedLines}Í∞úÏùò ÎùºÏù∏Ïù¥ ÌòïÏãùÏù¥ ÎßûÏßÄ ÏïäÏïÑ Î≥ÄÌôòÏóêÏÑú Ï†úÏô∏ÎêòÏóàÏäµÎãàÎã§.`, 'info');
            }

            if (allPairs.length === 0) {
                alert('Î≥ÄÌôòÏóê ÏÇ¨Ïö©Ìï† Ïú†Ìö®Ìïú Î≤àÏó≠ ÏåçÏùÑ Ï∞æÏßÄ Î™ªÌñàÏäµÎãàÎã§.');
                return;
            }

            // Í∏∏Ïù¥Î•º Í∏∞Ï§ÄÏúºÎ°ú ÎÇ¥Î¶ºÏ∞®Ïàú Ï†ïÎ†¨. Í∞ÄÏû• Í∏¥ Í≤ÉÎ∂ÄÌÑ∞ Î≥ÄÌôòÌï¥Ïïº Ï§ëÏ≤© Ïò§Î•ò Î∞©ÏßÄ
            allPairs.sort((a, b) => b.length - a.length);
            
            let result = inputText;
            const processedRanges = []; // Î≥ÄÌôòÎêú ÏòÅÏó≠ÏùÑ Í∏∞Î°ùÌï† Î∞∞Ïó¥
            let replacementCount = 0; 

            allPairs.forEach(pair => {
                let searchIndex = 0;
                
                while (true) {
                    const foundIndex = result.indexOf(pair.original, searchIndex);
                    if (foundIndex === -1) break;
                    
                    const foundEnd = foundIndex + pair.original.length;
                    
                    // Ï∞æÏùÄ ÏòÅÏó≠Ïù¥ Ïù¥Ï†ÑÏóê Î≥ÄÌôòÎêú ÏòÅÏó≠Í≥º Í≤πÏπòÎäîÏßÄ ÌôïÏù∏
                    const isOverlapping = processedRanges.some(range => 
                        (foundIndex < range.end && foundEnd > range.start)
                    );
                    
                    if (!isOverlapping) {
                        const before = result.substring(0, foundIndex);
                        const after = result.substring(foundEnd);
                        result = before + pair.translation + after;
                        
                        replacementCount++; 
                        currentLogData.push(`'${pair.original}' ‚Üí '${pair.translation}'`); 

                        const lengthDiff = pair.translation.length - pair.original.length;
                        
                        // Î≥ÄÌôòÎêú ÏòÅÏó≠ Ï†ïÎ≥¥Î•º Í∏∞Î°ù
                        processedRanges.push({
                            start: foundIndex,
                            end: foundIndex + pair.translation.length
                        });
                        
                        // Ïù¥ÌõÑÏóê Ï≤òÎ¶¨Îê† ÏòÅÏó≠Îì§Ïùò ÏúÑÏπòÎ•º Î∞îÎÄê Í∏∏Ïù¥ÎßåÌÅº Ï°∞Ï†ï
                        processedRanges.forEach(range => {
                            if (range.start > foundIndex) {
                                range.start += lengthDiff;
                                range.end += lengthDiff;
                            }
                        });
                        
                        searchIndex = foundIndex + pair.translation.length;
                    } else {
                        searchIndex = foundIndex + 1;
                    }
                }
            });

            document.getElementById('finalResult').value = result;

            if (replacementCount > 0) {
                showToast(`${replacementCount}Í∞ú Ìï≠Î™©Ïùò ÏùºÍ¥Ñ Î≥ÄÌôòÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.`, 'success');

                const finalResultText = document.getElementById('finalResult').value;
                const remainingChinese = finalResultText.match(/[\u4e00-\u9fff]+/g) || [];
                const pairsCount = allPairs.length;
                
                const targetContainer = document.getElementById('final-text-header');
                const remainingList = remainingChinese.length > 0
                    ? remainingChinese.map(c => `<code>"${c}"</code>`).join(', ')
                    : 'ÏóÜÏùå';
                
                const summaryHTML = `
                    <div style="padding-bottom: 10px; margin-bottom: 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); font-size: 11px; color: #ccc;">
                        <p style="margin: 0 0 4px;"><strong>ÏöîÏïΩ:</strong></p>
                        <p style="margin: 0 0 2px;">- ÏÇ¨Ïö©Îêú Î≥ÄÌôò Ïåç: ${pairsCount}Í∞ú</p>
                        <p style="margin: 0 0 2px;">- Ï¥ù Î≥ÄÌôò ÌöüÏàò: ${replacementCount}Ìöå</p>
                        <p style="margin: 0;">- ÎØ∏Î≥ÄÌôò Ï§ëÍµ≠Ïñ¥: ${remainingList}</p>
                    </div>
                `;
                
                const logListHTML = currentLogData.map((log, index) => {
                    const escapeHtml = (unsafe) => unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
                    const parts = log.split('‚Üí');
                    const original = parts[0] ? escapeHtml(parts[0].trim()) : '';
                    const translated = parts[1] ? escapeHtml(parts[1].trim()) : '';
                    return `<p style="margin:0 0 2px;"><span style="color: #aaa; width: 2.5em; display: inline-block;">${index + 1}.</span>${original} <span style="color: #888;">‚Üí</span> <span style="color: #63e6be;">${translated}</span></p>`;
                }).join('');
                
                const logContentHTML = summaryHTML + logListHTML;

                setupLogButton(targetContainer, logContentHTML, 'Î≥ÄÌôò Î°úÍ∑∏ Î≥¥Í∏∞');

            } else {
                showToast('Î≥ÄÌôòÌï† Ìï≠Î™©ÏùÑ Ï∞æÏßÄ Î™ªÌñàÏäµÎãàÎã§.', 'info');
            }
            validateFinalText();
        }

        function copyToClipboard() {
            const finalResult = document.getElementById('finalResult').value;
            if (!finalResult) {
                showToast('Î≥µÏÇ¨Ìï† ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            navigator.clipboard.writeText(finalResult).then(() => {
                showToast('ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.');
            }).catch(() => {
                showToast('ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            });
        }

        function downloadResult() {
            const finalResult = document.getElementById('finalResult').value;
            if (!finalResult) {
                showToast('Îã§Ïö¥Î°úÎìúÌï† ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            const fileName = currentFileName ? `${currentFileName}_translated${currentFileExtension}` : 'translated_result.txt';
            const blob = new Blob([finalResult], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            
            URL.revokeObjectURL(url);
        }

        function saveSettings() {
            const savedPrompts = JSON.parse(localStorage.getItem('savedPrompts') || '{}');

const settings = {
                sourceLanguage: document.getElementById('sourceLanguage').value,
                apiProvider: document.getElementById('apiProvider').value,
                apiModel: document.getElementById('apiModel').value,

                // localStorageÏóêÏÑú Í∞Å Ï†úÍ≥µÏûêÏùò API ÌÇ§Î•º ÏßÅÏ†ë ÏùΩÏñ¥ÏôÄ Ï†ÄÏû•Ìï©ÎãàÎã§.
                geminiApiKey: localStorage.getItem('geminiApiKey') || '',
                openaiApiKey: localStorage.getItem('openaiApiKey') || '',

                translationPrompt: document.getElementById('translationPrompt').value,
                savedPrompts: savedPrompts,

                temperature: document.getElementById('temperature').value,
                maxOutputTokens: document.getElementById('maxOutputTokens').value,
                topP: document.getElementById('topP').value,
                topK: document.getElementById('topK').value,
            };

            const dataStr = JSON.stringify(settings, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'EasyKr_settings.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function loadSettings() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const settings = JSON.parse(e.target.result);
                            
                            document.getElementById('sourceLanguage').value = settings.sourceLanguage || 'chinese';
                            document.getElementById('apiProvider').value = settings.apiProvider || 'gemini';
                            document.getElementById('apiModel').value = settings.apiModel || 'gemini-2.5-pro';
                            // 'apiKey'Î•º ÏßÅÏ†ë ÏÑ§Ï†ïÌïòÎäî ÎåÄÏã†, ÏïÑÎûò Î°úÏßÅÏù¥ localStorageÎ•º ÏóÖÎç∞Ïù¥Ìä∏Ìï©ÎãàÎã§.
                            
                            document.getElementById('translationPrompt').value = settings.translationPrompt || '';
                            
                            document.getElementById('temperature').value = settings.temperature || '1';
                            document.getElementById('maxOutputTokens').value = settings.maxOutputTokens || DEFAULT_MAX_OUTPUT;
                            document.getElementById('topP').value = settings.topP || '0.98';
                            document.getElementById('topK').value = settings.topK || '0';

                            // ÌååÏùºÏóê ÏûàÎäî Î™®Îì† ÏÑ§Ï†ïÏùÑ localStorageÏóê Ï†ÄÏû•Ìï©ÎãàÎã§.
                            // Ïù¥Î†áÍ≤å ÌïòÎ©¥ geminiApiKeyÏôÄ openaiApiKeyÎèÑ ÏûêÎèôÏúºÎ°ú Ï†ÄÏû•Îê©ÎãàÎã§.
                            for (const key in settings) {
                                if (Object.hasOwnProperty.call(settings, key)) {
                                    if (key === 'savedPrompts') {
                                        localStorage.setItem('savedPrompts', JSON.stringify(settings.savedPrompts));
                                    } else if (typeof settings[key] === 'string') {
                                        localStorage.setItem(key, settings[key]);
                                    }
                                }
                            }
                            
                            updatePromptSelect();
                            updateLanguageLabels();

                            // Ï†úÍ≥µÏûê Î≥ÄÍ≤Ω Ìï∏Îì§Îü¨Î•º Ìò∏Ï∂úÌïòÏó¨ Î™®Îç∏ Î™©Î°ùÍ≥º API ÌÇ§ ÏûÖÎ†•ÏùÑ ÏÉàÎ°úÍ≥†Ïπ®Ìï©ÎãàÎã§.
                            handleProviderChange();
                            
                            showToast('ÏÑ§Ï†ïÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î∂àÎü¨ÏôÄÏ°åÏäµÎãàÎã§!', 'success');
                        } catch (error) {
                            showToast('ÏÑ§Ï†ï ÌååÏùºÏùÑ ÏùΩÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }        
        
        function deletePrompt() {
            const select = document.getElementById('promptSelect');
            const selectedName = select.value;
            
            if (selectedName === 'default') {
                showToast('Í∏∞Î≥∏ ÌîÑÎ°¨ÌîÑÌä∏Îäî ÏÇ≠Ï†úÌï† Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            if (!confirm(`"${selectedName}" ÌîÑÎ°¨ÌîÑÌä∏Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                return;
            }
            
            const savedPrompts = JSON.parse(localStorage.getItem('savedPrompts') || '{}');
            delete savedPrompts[selectedName];
            localStorage.setItem('savedPrompts', JSON.stringify(savedPrompts));
            
            updatePromptSelect();
            resetToDefault();
            showToast('ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
        }
        
        function loadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) return;
            
            const fileName = file.name;
            const lastDotIndex = fileName.lastIndexOf('.');
            currentFileName = lastDotIndex !== -1 ? fileName.substring(0, lastDotIndex) : fileName;
            currentFileExtension = lastDotIndex !== -1 ? fileName.substring(lastDotIndex) : '';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('inputText').value = e.target.result;
                showToast(`ÌååÏùº "${fileName}"Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î°úÎìúÎêòÏóàÏäµÎãàÎã§.`);
                updateInputTextLabel();
                updateInputAnalysisViewer(); 
                updateCharCounter('inputText');
            };
            reader.readAsText(file, 'utf-8');
        }

        async function testConnection() {
            const apiKey = document.getElementById('apiKey').value;
            const model = document.getElementById('apiModel').value;
            const apiProvider = document.getElementById('apiProvider').value; // Ï†úÍ≥µÏûê ÌôïÏù∏
            const statusElement = document.getElementById('connectionStatus');

            if (!apiKey) {
                showToast('API ÌÇ§Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            statusElement.className = 'connection-status status-connecting';
            statusElement.textContent = 'Ïó∞Í≤∞ Ï§ë...';

            let apiEndpoint = '';
            let fetchOptions = {};

            if (apiProvider === 'openai') {
                // --- OpenAI Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ Î°úÏßÅ ---
                apiEndpoint = `https://api.openai.com/v1/models/${model}`;
                fetchOptions = {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`, // OpenAIÎäî Bearer ÌÜ†ÌÅ∞ Ïù∏Ï¶ù ÏÇ¨Ïö©
                    }
                };
            } else { // Í∏∞Î≥∏ÏùÄ 'gemini'
                // --- Í∏∞Ï°¥ Gemini Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ Î°úÏßÅ ---
                let geminiModel = model;
                if (geminiModel.endsWith('-latest')) {
                    geminiModel = geminiModel.slice(0, -7);
                }
                apiEndpoint = `https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}?key=${apiKey}`;
                fetchOptions = {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
            }

            try {
                const response = await fetch(apiEndpoint, fetchOptions);

                if (response.ok) {
                    const data = await response.json();
                    const displayName = data.displayName || data.id || model; // GeminiÎäî displayName, OpenAIÎäî id
                    statusElement.className = 'connection-status status-connected';
                    statusElement.textContent = `Ïó∞Í≤∞ ÏÑ±Í≥µ (${displayName})`;
                    showToast('API Ïó∞Í≤∞Ïóê ÏÑ±Í≥µÌñàÏäµÎãàÎã§!');
                } else {
                    const errorData = await response.json();
                    const errorMessage = errorData.error?.message || response.statusText;
                    throw new Error(`API Ïó∞Í≤∞ Ïã§Ìå®: ${errorMessage}`);
                }
            } catch (error) {
                statusElement.className = 'connection-status status-disconnected';
                statusElement.textContent = 'Ïó∞Í≤∞ Ïã§Ìå®';
                showToast(`API Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. API ÌÇ§, Î™®Îç∏Î™Ö, Ï†úÍ≥µÏûêÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.\nÏò§Î•ò: ${error.message}`);
            }
        }

        function getLanguageRegex(language) {
            const patterns = {
                'english': /[Í∞Ä-Ìû£\u4e00-\u9fff]*[a-zA-Z]+[Í∞Ä-Ìû£\u4e00-\u9fffa-zA-Z\s,.!?;:'"()\-]*[a-zA-Z]*|[a-zA-Z]+[Í∞Ä-Ìû£\u4e00-\u9fffa-zA-Z\s,.!?;:'"()\-]*|[a-zA-Z]{2,}/g,
                'japanese': /[Í∞Ä-Ìû£\u4e00-\u9fff]*[\u3040-\u309f\u30a0-\u30ff]+[Í∞Ä-Ìû£\u4e00-\u9fff\u3040-\u309f\u30a0-\u30ff\s,.!?;:'"()\-]*[\u3040-\u309f\u30a0-\u30ff]*|[\u3040-\u309f\u30a0-\u30ff]+[Í∞Ä-Ìû£\u4e00-\u9fff\u3040-\u309f\u30a0-\u30ff\s,.!?;:'"()\-]*|[\u3040-\u309f\u30a0-\u30ff]{1,}/g,
                'korean': /[a-zA-Z\u4e00-\u9fff]*[Í∞Ä-Ìû£]+[a-zA-Z\u4e00-\u9fffÍ∞Ä-Ìû£\s,.!?;:'"()\-]*[Í∞Ä-Ìû£]*|[Í∞Ä-Ìû£]+[a-zA-Z\u4e00-\u9fffÍ∞Ä-Ìû£\s,.!?;:'"()\-]*|[Í∞Ä-Ìû£]{1,}/g
            };
            return patterns[language] || null; 
        }

        function extractLanguageSegments(text, language) {
            const results = [];
            
            if (language === 'chinese') {
                
                const stringLiteralRegex = /["'`]([^"'`]*[\u4e00-\u9fff][^"'`]*)["'`]/g;
                let match;
                
                while ((match = stringLiteralRegex.exec(text)) !== null) {
                    const content = match[1];
                    extractChineseSegments(content, results);
                }
                
                const commentRegex = /\/\*([^*]*[\u4e00-\u9fff][^*]*)\*\/|\/\/([^\n\r]*[\u4e00-\u9fff][^\n\r]*)/g;
                while ((match = commentRegex.exec(text)) !== null) {
                    const content = match[1] || match[2];
                    if (content) {
                        extractChineseSegments(content, results);
                    }
                }
                
                const htmlContentRegex = />([^<]*[\u4e00-\u9fff][^<]*)</g;
                while ((match = htmlContentRegex.exec(text)) !== null) {
                    const content = match[1];
                    extractChineseSegments(content, results);
                }
                
                const lines = text.split(/\n/);
                lines.forEach(line => {
                    if (!/^\s*(function|var|let|const|if|for|while|class|\}|\{|\/\/)/.test(line)) {
                        extractChineseSegments(line, results);
                    }
                });
                
                let uniqueResults = [...new Set(results)]
                    .filter(text => text.trim().length > 0)
                    .map(text => {
                        
                        return text.replace(/^[`'"'"'"„Äå„Äç„Äé„ÄèÔºàÔºâ„Äê„Äë„Äà„Äâ„Ää„Äã„Äî„Äï„Äñ„Äó]+|[`'"'"'"„Äå„Äç„Äé„ÄèÔºàÔºâ„Äê„Äë„Äà„Äâ„Ää„Äã„Äî„Äï„Äñ„Äó]+$/g, '');
                    })
                    .filter(text => text.length > 0);
                
                uniqueResults = [...new Set(uniqueResults)];
                return uniqueResults;

            } else {
                
                const languageRegex = getLanguageRegex(language);
                const matches = text.match(languageRegex);
                return matches ? [...new Set(matches)].filter(s => s.trim() !== '') : [];
            }
        }

        function extractChineseSegments(text, results) {
            if (!text) return;

            const longSegmentRegex = /[a-zA-Z0-9${}*]*[\u4e00-\u9fff][\u4e00-\u9fff\s\u3000-\u303f\uff00-\uffef„ÄÇÔºÅÔºüÔºå„ÄÅÔºöÔºõ""„Äå„Äç„Äé„ÄèÔºàÔºâ„Äê„Äë„Äà„Äâ„Ää„Äã„Äî„Äï„Äñ„Äó""''‚Ä¶‚ÄîÔΩû¬∑\-_()\/\\&ÔºÜ@*‚ÜîÔ∏è‚û°Ô∏è‚¨ÖÔ∏è‚¨ÜÔ∏è‚¨áÔ∏èüîÑüìÅüíæüóëÔ∏è‚úÖüìã‚ú®üîß‚öôÔ∏èüìùüá®üá≥üá∫üá∏üáØüáµüá∑üá∫üá∞üá∑0-9a-zA-Z${}"`]*[\u4e00-\u9fff][a-zA-Z0-9${}*"`„ÄÇ]*/g;
            let longMatches = text.match(longSegmentRegex) || [];
            let extractedRanges = []; 

            longMatches.forEach(segment => {
                let cleaned = segment.trim();
                if (cleaned && /[\u4e00-\u9fff]/.test(cleaned)) {
                    results.push(cleaned);
                    
                    let startIndex = text.indexOf(segment);
                    if (startIndex !== -1) {
                        extractedRanges.push({
                            start: startIndex,
                            end: startIndex + segment.length,
                            text: segment
                        });
                    }
                }
            });

            const shortRegex = /[a-zA-Z0-9${}]*[\u4e00-\u9fff]+[a-zA-Z0-9${}]*(?:[„ÄÇÔºÅÔºüÔºå])?/g;
            let match;
            
            while ((match = shortRegex.exec(text)) !== null) {
                let cleaned = match[0].trim();
                if (cleaned && /[\u4e00-\u9fff]/.test(cleaned) && cleaned.length >= 1) {
                    let matchStart = match.index;
                    let matchEnd = match.index + match[0].length;
                    
                    
                    let isOverlapping = extractedRanges.some(range => {
                        return (matchStart >= range.start && matchEnd <= range.end);
                    });
                    
                    
                    if (!isOverlapping) {
                        results.push(cleaned);
                    }
                }
            }
        }

        function handleInputTextChange() {
            updateReplaceButtonState();
            updateInputTextLabel();
            updateInputAnalysisViewer();
            updateCharCounter('inputText');
            
            document.querySelector('button[onclick="translateText()"]').disabled = true;
            
            const extractStats = document.getElementById('extractStats');
            if (extractStats.style.display === 'block') {
                if (!extractStats.innerHTML.includes('[ÏõêÎ≥∏Ïù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§')) {
                    extractStats.innerHTML += ' <strong style="color: var(--text-status-connecting);">[ÏõêÎ≥∏Ïù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§. Îã§Ïãú Ï∂îÏ∂úÌï¥Ï£ºÏÑ∏Ïöî!]</strong>';
                }
            }
        }

        function extractChinese() {
            const inputText = document.getElementById('inputText').value;
            const selectedLanguage = document.getElementById('sourceLanguage').value;

            const extractedChineseEl = document.getElementById('extractedChinese');
            const translationResultEl = document.getElementById('translationResult');
            const finalResultEl = document.getElementById('finalResult');

            if (!inputText.trim()) {
                showToast('ÏûÖÎ†• ÌÖçÏä§Ìä∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            if (extractedChineseEl.value || translationResultEl.value || finalResultEl.value) {
                if (!confirm("Ïù¥ÎØ∏ ÏûëÏóÖ ÎÇ¥Ïö©Ïù¥ Ï°¥Ïû¨Ìï©ÎãàÎã§. Ï∂îÏ∂úÏùÑ Îã§Ïãú Ïã§ÌñâÌïòÎ©¥ ÏïÑÎûò Ï∞ΩÏùò ÎÇ¥Ïö©Ïù¥ Î™®Îëê Ï¥àÍ∏∞ÌôîÎê©ÎãàÎã§. Í≥ÑÏÜçÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
                    return; 
                }
                
                extractedChineseEl.value = '';
                translationResultEl.value = '';
                finalResultEl.value = '';
                document.getElementById('extractStats').style.display = 'none';
                document.getElementById('translationStats').style.display = 'none';
                document.getElementById('validationResult').style.display = 'none';
                document.querySelector('button[onclick="translateText()"]').disabled = true;
                document.querySelector('button[onclick="replaceText()"]').disabled = true;
                removeLogUI(); 
                extractedChineseArray = [];
                translationPairs.clear();
            }
            
            const extractedResults = extractLanguageSegments(inputText, selectedLanguage);
            if (!extractedResults || extractedResults.length === 0) {
                const langName = labels[selectedLanguage] || 'Ïô∏Íµ≠Ïñ¥';
                showToast(`Ìï¥Îãπ ${langName}Í∞Ä Î∞úÍ≤¨ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.`);
                return;
            }

            extractedChineseArray = extractedResults;

            const joinedText = extractedChineseArray.join('');
            const chineseCharCount = (joinedText.match(/[\u4e00-\u9fff]/g) || []).length;
            
            extractedChineseEl.value = extractedChineseArray.join('\n');
            updateCharCounter('extractedChinese');
            
            const extractStats = document.getElementById('extractStats');
            const languageType = document.getElementById('languageType'); 
            
            extractStats.innerHTML = `<strong>Ï∂îÏ∂ú Í≤∞Í≥º:</strong> <span id="languageType">${languageType.textContent}</span> ${chineseCharCount}Ïûê, <span id="extractCount">${extractedChineseArray.length}</span>Í∞úÏùò <span id="languageType">${languageType.textContent}</span> Î¨∏ÏûêÏó¥Ïù¥ Î∞úÍ≤¨ÎêòÏóàÏäµÎãàÎã§.`;
            extractStats.style.display = 'block';

            if (extractedChineseArray.length > 0) {
                document.querySelector('button[onclick="translateText()"]').disabled = false;
            }
            
            const langName = (typeof labels !== 'undefined' && labels[selectedLanguage]) ? labels[selectedLanguage] : 'Ïô∏Íµ≠Ïñ¥';
            showToast(`${extractedChineseArray.length}Í∞úÏùò ${langName} Î¨∏ÏûêÏó¥Ïù¥ Ï∂îÏ∂úÎêòÏóàÏäµÎãàÎã§.`);
        }

        function convertChinesePunctuation() {
            const inputText = document.getElementById('inputText').value;
            if (!inputText) {
                showToast('Î≥ÄÌôòÌï† ÌÖçÏä§Ìä∏Í∞Ä ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            const converted = inputText
                .replace(/„ÄÇ/g, '.')
                .replace(/ÔºÅ/g, '!')
                .replace(/Ôºü/g, '?')
                .replace(/Ôºà/g, '(')
                .replace(/Ôºâ/g, ')')
                .replace(/Ôºö/g, ':')
                .replace(/Ôºõ/g, ';')
                .replace(/„ÄÅ/g, ',');
            
            document.getElementById('inputText').value = converted;
            showToast('ÏûÖÎ†• ÌÖçÏä§Ìä∏Ïùò Ï§ëÍµ≠Ïñ¥ Î¨∏Ïû•Î∂ÄÌò∏Í∞Ä Î≥ÄÌôòÎêòÏóàÏäµÎãàÎã§.');
        }
        
        function setTheme(button) {
            const themeName = button.getAttribute('data-theme');
            document.body.setAttribute('data-theme', themeName);
            localStorage.setItem('selectedTheme', themeName);

            document.querySelectorAll('.theme-button').forEach(btn => btn.classList.remove('active'));
            
            button.classList.add('active');
        }

        function applySavedTheme() {
            const savedTheme = localStorage.getItem('selectedTheme') || 'original-pink'; 
            document.body.setAttribute('data-theme', savedTheme);

            
            document.querySelectorAll('.theme-button').forEach(btn => btn.classList.remove('active'));
            
            const activeButton = document.querySelector(`.theme-button[data-theme="${savedTheme}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
        }
        
        function exportTranslationPairs() {
            const text = document.getElementById('translationResult').value;
            if (!text.trim()) {
                showToast('ÎÇ¥Î≥¥ÎÇº ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.');
                return;
            }
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'EasyKr_pairs.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        function updateInputTextLabel() {
            const inputText = document.getElementById('inputText').value;
            const label = document.getElementById('input-text-label');
            const sourceLanguage = document.getElementById('sourceLanguage').value;

            const labels = {
                'chinese': 'Ï§ëÍµ≠Ïñ¥',
                'english': 'ÏòÅÏñ¥',
                'japanese': 'ÏùºÎ≥∏Ïñ¥',
                'korean': 'ÌïúÍµ≠Ïñ¥'
            };
            const sourceLangName = labels[sourceLanguage] || 'Ïô∏Íµ≠Ïñ¥';
            const targetLangName = sourceLanguage === 'korean' ? 'Ïô∏Íµ≠Ïñ¥' : 'ÌïúÍµ≠Ïñ¥';

            let newLabelText = `${sourceLangName} ‚Üí ${targetLangName}`;
            
            if (inputText.trim() && sourceLanguage === 'chinese') {
                const chineseCharCount = (inputText.match(/[\u4e00-\u9fff]/g) || []).length;
                
                if (chineseCharCount > 0) {
                    
                    newLabelText = `${sourceLangName} (${chineseCharCount}Ïûê) ‚Üí ${targetLangName}`;
                }
            }
            
            label.textContent = newLabelText;
        }

        function updateTranslationStatsFromTextarea() {
            const text = document.getElementById('translationResult').value;
            const statsDiv = document.getElementById('translationStats');
            const countSpan = document.getElementById('translationCount');

            if (!text.trim()) {
                statsDiv.style.display = 'none';
                return;
            }
            
            const pairCount = text.split('\n').filter(line => {
                const equalIndex = line.indexOf('=');
                return equalIndex !== -1 && line.substring(equalIndex + 1).trim().length > 0;
            }).length;


            if (pairCount > 0) {
                countSpan.textContent = pairCount;
                statsDiv.style.display = 'block';
            } else {
                statsDiv.style.display = 'none';
            }
        }

        function importTranslationPairs() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.txt,.json'; 
            input.onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const content = e.target.result;
                        let output = '';

                        if (file.name.toLowerCase().endsWith('.json')) {
                            try {
                                const jsonData = JSON.parse(content);
                                
                                for (const key in jsonData) {
                                    if (Object.hasOwnProperty.call(jsonData, key)) {
                                        output += `${key}=${jsonData[key]}\n`;
                                    }
                                }
                                showToast('JSON ÌååÏùºÏùÑ "ÏõêÎ≥∏=Î≤àÏó≠" ÌòïÏãùÏúºÎ°ú Î≥ÄÌôòÌïòÏó¨ Î∂àÎü¨ÏôîÏäµÎãàÎã§.');
                            } catch (error) {
                                showToast('JSON ÌååÏùº ÌååÏã±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÌååÏùº ÎÇ¥Ïö©ÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.\nÏò§Î•ò: ' + error.message);
                                output = content; 
                            }
                        } else {
                            
                            output = content;
                            showToast('TXT ÌååÏùºÏùÑ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î∂àÎü¨ÏôîÏäµÎãàÎã§.');
                        }
                        
                        document.getElementById('translationResult').value = output;
                        updateCharCounter('translationResult');
                        updateReplaceButtonState();
                        updateTranslationStatsFromTextarea();
                        toggleSpecialCharCheckButtonVisibility();
                    };
                    reader.readAsText(file, 'utf-8');
                }
            };
            input.click();
        }
        
        function validateFinalText() {
            const text = document.getElementById('finalResult').value;
            const resultDiv = document.getElementById('validationResult');
            if (!text.trim()) {
                resultDiv.style.display = 'none';
                return;
            }

            let results = [];
            let warnings = [];
            const lines = text.split('\n');

            const chineseChars = text.match(/[\u4e00-\u9fff]/g) || [];
            if (chineseChars.length > 0) {
                warnings.push(`ÏûîÏó¨ Ï§ëÍµ≠Ïñ¥ ${chineseChars.length}Ïûê Î∞úÍ≤¨: ${chineseChars.slice(0, 10).join('')}...`);
            } else {
                results.push(`ÏûîÏó¨ Ï§ëÍµ≠Ïñ¥ ÏóÜÏùå`);
            }
            
            const stack = [];
            const pairs = { '(': ')', '{': '}', '[': ']', '"': '"', "'": "'" };
            let errorFound = false;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    
                    if (char === '\\' && j + 1 < line.length) {
                        j++;
                        continue;
                    }

                    if (Object.keys(pairs).includes(char)) {
                        
                        if (char === stack[stack.length - 1] && (char === '"' || char === "'")) {
                            
                            stack.pop();
                        } else {
                            stack.push(char);
                        }
                    } else if (Object.values(pairs).includes(char)) {
                        
                        if (pairs[stack[stack.length - 1]] === char) {
                            stack.pop();
                        } else {
                            warnings.push(`${i + 1}Î≤àÏß∏ Ï§Ñ: Îã´Îäî Í¥ÑÌò∏ ÏßùÏù¥ ÎßûÏßÄ ÏïäÏäµÎãàÎã§. (<code>...${line.substring(Math.max(0, j-10), j+1)}...</code>)`);
                            errorFound = true;
                            break;
                        }
                    }
                }
                if (errorFound) break;
            }

            if (!errorFound) {
                if (stack.length > 0) {
                    warnings.push(`Îã´ÌûàÏßÄ ÏïäÏùÄ Í¥ÑÌò∏/Îî∞Ïò¥ÌëúÍ∞Ä ÏûàÏäµÎãàÎã§: ${stack.join(', ')}`);
                } else {
                    results.push('Í¥ÑÌò∏ Î∞è Îî∞Ïò¥Ìëú ÏßùÏù¥ Î™®Îëê ÎßûÏùå');
                }
            }
            
            for (let i = 0; i < lines.length - 1; i++) {
                const currentLine = lines[i].trim();
                const nextLine = lines[i+1].trim();

                if ((currentLine.endsWith('}') || currentLine.endsWith(']') || currentLine.endsWith('"')) && nextLine.startsWith('"') && !currentLine.endsWith(',')) {
                    warnings.push(`${i + 1}Î≤àÏß∏ Ï§Ñ ÎÅù: JSON Ìï≠Î™© ÏÇ¨Ïù¥Ïóê ÏâºÌëú(,)Í∞Ä ÎàÑÎùΩÎêòÏóàÏùÑ Ïàò ÏûàÏäµÎãàÎã§.`);
                }
            }
            
            let report = '<strong>Í≤ÄÏÇ¨ Í≤∞Í≥º:</strong>';
            results.forEach(r => report += `<p style="display: flex; align-items: center; gap: 6px;"><i data-feather="check" class="text-status-connected"></i> ${r}</p>`);
            warnings.forEach(w => {
                report += `<p style="display: flex; align-items: start; gap: 6px;"><i data-feather="alert-triangle" class="text-status-disconnected" style="flex-shrink: 0; margin-top: 3px;"></i> <span>${w}</span></p>`;
            });

            if (warnings.length === 0) {
                report += '<p style="font-weight: bold; color: var(--text-status-connected); margin-top: 10px;">Î¨∏Ï†úÍ∞Ä Î∞úÍ≤¨ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. (Ïù¥ Í≤ÄÏÇ¨Îäî ÏôÑÎ≤ΩÌïòÏßÄ ÏïäÏúºÎãà Ï∞∏Í≥†Ïö©ÏúºÎ°úÎßå ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî)</p>';
            }

            report += '<hr style="border: 0; border-top: 1px solid var(--border-main); margin: 12px 0 8px 0;">';
            report += '<p style="font-size: 12px; color: var(--text-subtitle); text-align: center; margin: 0;">ÏûêÏÑ∏Ìïú ÏÇ¨Ìï≠ÏùÄ Ìå®ÎÑê Ïö∞Ï∏° ÏÉÅÎã®Ïùò Î°úÍ∑∏Î•º Ï∞∏Í≥†ÌïòÏÑ∏Ïöî</p>';

            resultDiv.innerHTML = report;
            resultDiv.style.display = 'block';
            feather.replace();
        }
        
        function updateInputAnalysisViewer() { 
            const text = document.getElementById('inputText').value;
            const targetContainer = document.getElementById('input-text-header');

            removeLogUI(); 

            if (!text.trim()) return;
            
            const escapeHtml = (unsafe) => unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
            
            const chineseRegex = /[\u4e00-\u9fff]/;
            const placeholderRegex = /{{\s*(.*?)\s*}}/g;
            const placeholderMatches = [...new Set(text.match(placeholderRegex) || [])];
            placeholderMatches.sort((a, b) => chineseRegex.test(b) - chineseRegex.test(a)); // Ï§ëÍµ≠Ïñ¥ Ìè¨Ìï® Ìï≠Î™©ÏùÑ ÏúÑÎ°ú

            let placeholderHtml = '';
            if (placeholderMatches.length > 0) {
                placeholderHtml += `
                    <div style="padding-bottom: 10px; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 12px; color: #ccc;">
                        <p style="margin: 0 0 4px;"><strong>ÌîåÎ†àÏù¥Ïä§ÌôÄÎçî ÏöîÏïΩ:</strong></p>
                        <p style="margin: 0;">Ï¥ù <strong>${placeholderMatches.length}Í∞ú</strong>Ïùò Í≥†Ïú†Ìïú ÌîåÎ†àÏù¥Ïä§ÌôÄÎçîÍ∞Ä Î∞úÍ≤¨ÎêòÏóàÏäµÎãàÎã§.</p>
                    </div>
                `;
                placeholderMatches.forEach((item, index) => {
                    const truncatedItem = item.length > 50 ? escapeHtml(item.substring(0, 50)) + '...' : escapeHtml(item);
                    placeholderHtml += `<p style="margin:0 0 2px;"><span style="color: #aaa; width: 2.5em; display: inline-block;">${index + 1}.</span><code>${truncatedItem}</code></p>`;
                });
            }

            const varRegex = /(?:const|let|var)\s+([a-zA-Z0-9_$]*[\u4e00-\u9fff]+[a-zA-Z0-9_$]*)|(?:const|let|var)\s+([a-zA-Z_$][a-zA-Z0-9_$]*)/g;
            const varMatches = [...new Set(Array.from(text.matchAll(varRegex), m => m[1] || m[2]))];
            varMatches.sort((a, b) => chineseRegex.test(b) - chineseRegex.test(a)); // Ï§ëÍµ≠Ïñ¥ Ìè¨Ìï® Ìï≠Î™©ÏùÑ ÏúÑÎ°ú

            let varHtml = '';
            if (varMatches.length > 0) {
                varHtml += `
                    <div style="padding-bottom: 10px; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 12px; color: #ccc;">
                        <p style="margin: 0 0 4px;"><strong>JS Î≥ÄÏàò ÏÑ†Ïñ∏ ÏöîÏïΩ:</strong></p>
                        <p style="margin: 0;">Ï¥ù <strong>${varMatches.length}Í∞ú</strong>Ïùò Í≥†Ïú†Ìïú Î≥ÄÏàòÍ∞Ä ÏÑ†Ïñ∏ÎêòÏóàÏäµÎãàÎã§.</p>
                    </div>
                `;
                varMatches.forEach((item, index) => {
                    varHtml += `<p style="margin:0 0 2px;"><span style="color: #aaa; width: 2.5em; display: inline-block;">${index + 1}.</span><code>${escapeHtml(item)}</code></p>`;
                });
            }

            let finalLogContent = '';
            if (placeholderHtml) {
                finalLogContent += placeholderHtml;
            }
            if (varHtml) {
                if (placeholderHtml) { 
                    finalLogContent += '<hr style="border: 0; border-top: 1px solid rgba(255, 255, 255, 0.1); margin: 12px 0;">';
                }
                finalLogContent += varHtml;
            }
            
            if (finalLogContent) {
                setupLogButton(targetContainer, finalLogContent, 'ÏûÖÎ†• ÌÖçÏä§Ìä∏ Î∂ÑÏÑù Î≥¥Í∏∞');
            }
        }
        
        function setupLogButton(targetContainer, logContentHTML, logTitle = 'Î≥ÄÌôò Î°úÍ∑∏ Î≥¥Í∏∞') {
            if (!targetContainer || !logContentHTML) return;

            const existingBtn = targetContainer.querySelector('.btn-log-viewer');
            const existingPopover = targetContainer.querySelector('.log-popover');
            if (existingBtn) existingBtn.remove();
            if (existingPopover) existingPopover.remove();
            
            const popover = document.createElement('div');
            popover.className = 'log-popover';
            popover.innerHTML = logContentHTML;
            
            const button = document.createElement('button');
            button.className = 'btn-log-viewer';
            button.title = logTitle;
            button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>`;
            
            targetContainer.appendChild(button);
            targetContainer.appendChild(popover);
            feather.replace();
            
            const handleOutsideClick = (event) => {
                if (!button.contains(event.target) && !popover.contains(event.target)) {
                    popover.classList.remove('visible');
                    document.removeEventListener('click', handleOutsideClick);
                }
            };
            
            button.addEventListener('click', (event) => {
                event.stopPropagation(); 
                const isVisible = popover.classList.toggle('visible');
                
                if (isVisible) {
                    document.addEventListener('click', handleOutsideClick);
                } else {
                    document.removeEventListener('click', handleOutsideClick);
                }
            });

        }

        function removeLogUI() {
            const existingBtn = document.querySelector('.btn-log-viewer');
            const existingPopover = document.querySelector('.log-popover');
            if (existingBtn) existingBtn.remove();
            if (existingPopover) existingPopover.remove();
        }

                function getCharCounts(charArray) {
            return charArray.reduce((acc, char) => {
                acc[char] = (acc[char] || 0) + 1;
                return acc;
            }, {});
        }

        function validateSpecialCharacters() {
            const text = document.getElementById('translationResult').value;
            if (!text.trim()) {
                showToast('Í≤ÄÏÇ¨Ìï† Î≤àÏó≠ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.', 'info');
                return;
            }

            const specialCharRegex = /[^\p{L}\p{N}\s]/gu;
            
            const lines = text.split('\n');
            const mismatches = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                if (!line.trim() || !line.includes('=')) continue;

                const equalIndex = line.indexOf('=');
                const original = line.substring(0, equalIndex);
                const translated = line.substring(equalIndex + 1);

                const originalChars = original.match(specialCharRegex) || [];
                const translatedChars = translated.match(specialCharRegex) || [];

                if (originalChars.length !== translatedChars.length) {
                    mismatches.push({ lineNum: i + 1, original, translated, originalChars, translatedChars });
                    continue;
                }

                const originalCounts = getCharCounts(originalChars);
                const translatedCounts = getCharCounts(translatedChars);

                let isMatch = true;
                for (const char in originalCounts) {
                    if (originalCounts[char] !== translatedCounts[char]) {
                        isMatch = false;
                        break;
                    }
                }

                if (isMatch) {
                    for (const char in translatedCounts) {
                        if (translatedCounts[char] !== originalCounts[char]) {
                            isMatch = false;
                            break;
                        }
                    }
                }

                if (!isMatch) {
                    mismatches.push({ lineNum: i + 1, original, translated, originalChars, translatedChars });
                }
            }

            const countOccurrences = (str, sub) => str.split(sub).length - 1;

            const specialChars = ['{', '}', '[', ']', '(', ')', '"', '"', '"', "'", "'", "'", '`', '<', '>', '\\', '{{', '}}', '|', '*', '_', '~', '^', '%', '$', '#', '@'];

            mismatches.sort((a, b) => {
                const aHasMismatch = specialChars.some(char => 
                    countOccurrences(a.original, char) !== countOccurrences(a.translated, char)
                );
                
                const bHasMismatch = specialChars.some(char => 
                    countOccurrences(b.original, char) !== countOccurrences(b.translated, char)
                );

                if (aHasMismatch && !bHasMismatch) return -1;
                if (!aHasMismatch && bHasMismatch) return 1;
                return 0;
            });

            const targetContainer = document.getElementById('translation-result-header');

            if (mismatches.length > 0) {
                showToast(`Í≤ÄÏÇ¨ ÏôÑÎ£å: ${mismatches.length}Í∞úÏùò ÎùºÏù∏ÏóêÏÑú ÌäπÏàòÎ¨∏Ïûê Î∂àÏùºÏπòÍ∞Ä Î∞úÍ≤¨ÎêòÏóàÏäµÎãàÎã§.`, 'error');

                let logContentHTML = `
                    <div style="padding-bottom: 10px; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 12px; color: #ccc; overflow: hidden;">
                        <div style="float: left;">
                            <p style="margin: 0 0 4px;"><strong>Í≤ÄÏÇ¨ ÏöîÏïΩ:</strong></p>
                            <p style="margin: 0;">Ï¥ù ${lines.filter(l => l.includes('=')).length}Ï§Ñ Ï§ë <strong id="mismatch-count" style="color: #f0a7a7;">${mismatches.length}</strong> ÎùºÏù∏ÏóêÏÑú Î∂àÏùºÏπòÍ∞Ä Î∞úÍ≤¨ÎêòÏóàÏäµÎãàÎã§.</p>
                        </div>
                        <div style="float: left; font-size: 11px; margin-top: 5px;">
                            <label-checkbox style="cursor: pointer; display: flex; align-items: center; gap: 4px;">
                                <input type="checkbox" id="hide-comma-mismatch-checkbox" onchange="filterLogView()">
                                ÏâºÌëú Í∞úÏàòÎßå Îã§Î•∏ Í≤ΩÏö∞ Ïà®Í∏∞Í∏∞
                            </label>
                        </div>
                    </div>
                `;
                
                mismatches.forEach(item => {
                    const originalCounts = getCharCounts(item.originalChars);
                    const translatedCounts = getCharCounts(item.translatedChars);
                    
                    const tempOriginalCounts = { ...originalCounts };
                    const tempTranslatedCounts = { ...translatedCounts };
                    delete tempOriginalCounts[','];
                    delete tempOriginalCounts['Ôºå'];
                    delete tempTranslatedCounts[','];
                    delete tempTranslatedCounts['Ôºå'];

                    const isCommaOnlyMismatch = JSON.stringify(tempOriginalCounts) === JSON.stringify(tempTranslatedCounts);

                    const escapeHtml = (unsafe) => unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
                    const originalCharsStr = item.originalChars.map(c => `<code>${escapeHtml(c)}</code>`).join(' ');
                    const translatedCharsStr = item.translatedChars.map(c => `<code>${escapeHtml(c)}</code>`).join(' ');

                    logContentHTML += `
                        <div class="log-mismatch-item" ${isCommaOnlyMismatch ? 'data-is-comma-only="true"' : ''} style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.08);">
                            <p style="color: #aaa; font-weight: bold; margin: 0 0 5px;">Line ${item.lineNum}:</p>
                            <p style="margin: 0 0 2px;"><span style="color:#888;">ÏõêÎ≥∏:</span> <code>${escapeHtml(item.original)}</code></p>
                            <p style="margin: 0 0 8px;"><span style="color:#888;">Î≤àÏó≠:</span> <code style="color: #63e6be;">${escapeHtml(item.translated)}</code></p>
                            <p style="margin: 0 0 2px; font-size: 11px; color: #f0a7a7;"><strong style="color: #aaa;">Î∂àÏùºÏπò ÏÉÅÏÑ∏:</strong></p>
                            <p style="margin: 0 0 2px; font-size: 11px; color: #ddd;">- ÏõêÎ≥∏ ÌäπÏàòÎ¨∏Ïûê (${item.originalChars.length}Í∞ú): ${originalCharsStr || 'ÏóÜÏùå'}</p>
                            <p style="margin: 0; font-size: 11px; color: #ddd;">- Î≤àÏó≠ ÌäπÏàòÎ¨∏Ïûê (${item.translatedChars.length}Í∞ú): ${translatedCharsStr || 'ÏóÜÏùå'}</p>
                        </div>
                    `;
                });
                setupLogButton(targetContainer, logContentHTML, 'ÌäπÏàòÎ¨∏Ïûê Í≤ÄÏÇ¨ Î°úÍ∑∏ Î≥¥Í∏∞');
            } else {
                const existingBtn = targetContainer.querySelector('.btn-log-viewer');
                if (existingBtn) existingBtn.remove();
                const existingPopover = targetContainer.querySelector('.log-popover');
                if (existingPopover) existingPopover.remove();

                showToast('Í≤ÄÏÇ¨ ÏôÑÎ£å: Î™®Îì† ÌäπÏàòÎ¨∏ÏûêÍ∞Ä ÏùºÏπòÌï©ÎãàÎã§!', 'success');
            }
        }

        function filterLogView() {
            const checkbox = document.getElementById('hide-comma-mismatch-checkbox');
            const items = document.querySelectorAll('.log-mismatch-item');
            let visibleMismatches = 0;

            items.forEach(item => {
                const isCommaOnly = item.getAttribute('data-is-comma-only') === 'true';
                if (checkbox.checked && isCommaOnly) {
                    item.style.display = 'none';
                } else {
                    item.style.display = 'block';
                    visibleMismatches++;
                }
            });

            const countElement = document.getElementById('mismatch-count');
            if (countElement) {
                countElement.textContent = visibleMismatches;
            }
        }

        function toggleUpdateLog(event) {
            event.stopPropagation();
            const popover = document.getElementById('update-log-popover');
            const isVisible = popover.classList.toggle('visible');

            const handleOutsideClick = (e) => {
                if (!popover.contains(e.target)) {
                    popover.classList.remove('visible');
                    document.removeEventListener('click', handleOutsideClick);
                }
            };
            
            if (isVisible) {
                // Îã§Î•∏ ÌåùÏò§Î≤ÑÎäî Îã´Í∏∞
                const otherPopovers = document.querySelectorAll('.log-popover.visible');
                otherPopovers.forEach(p => {
                    if(p.id !== 'update-log-popover') p.classList.remove('visible');
                });
                document.addEventListener('click', handleOutsideClick);
            } else {
                document.removeEventListener('click', handleOutsideClick);
            }
        }

        applySavedTheme(); 
        feather.replace(); 
    </script>
</body>
</html>
